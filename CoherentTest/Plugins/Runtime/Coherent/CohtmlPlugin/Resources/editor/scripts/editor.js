"use strict";var __awaiter=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(o,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function r(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){e.done?o(e.value):new n(function(t){t(e.value)}).then(a,r)}l((i=i.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){function n(e){return function(t){return i([e,t])}}function i(n){if(o)throw new TypeError("Generator is already executing.");for(;l;)try{if(o=1,s&&(a=s[2&n[0]?"return":n[0]?"throw":"next"])&&!(a=a.call(s,n[1])).done)return a;switch(s=0,a&&(n=[0,a.value]),n[0]){case 0:case 1:a=n;break;case 4:return l.label++,{value:n[1],done:!1};case 5:l.label++,s=n[1],n=[0];continue;case 7:n=l.ops.pop(),l.trys.pop();continue;default:if(a=l.trys,!(a=a.length>0&&a[a.length-1])&&(6===n[0]||2===n[0])){l=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){l.label=n[1];break}if(6===n[0]&&l.label<a[1]){l.label=a[1],a=n;break}if(a&&l.label<a[2]){l.label=a[2],l.ops.push(n);break}a[2]&&l.ops.pop(),l.trys.pop();continue}n=t.call(e,l)}catch(e){n=[6,e],s=0}finally{o=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var o,s,a,r,l={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return r={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r};Object.defineProperty(exports,"__esModule",{value:!0});var enums_1=require("lib/enums"),key_handlers_1=require("lib/key_handlers"),function_helpers_1=require("lib/function_helpers"),importCss_1=require("lib/animations/importCss"),build_widget_settings_1=require("lib/build_widget_settings"),editor_settings_1=require("lib/editor_settings"),system_config_1=require("lib/configs/system_config"),components_1=require("lib/components/components"),newFileCounter=0,coui;!function(e){var t={open:0,pendingClose:1,safelyClosable:2},n={},i={},o=!1,s=function(){function e(){window.LOADING_SCREEN_ON=!1,this.missingWidgets=[],this.__mainSceneIdToBeClosed=null,this.PENDING_PUBLISH_PAGE_LOAD=!1,this.PENDING_WIDGET_EXPORT=!1,this.PENDING_WIDGET_LOAD=!1,this.EXPORTING_WIDGET=!1,this.PENDING_SCENE_LOAD=!1,this.EXPORTING_COMPONENT=!1,this._isClosingInOrder=!1,this.openFiles={},this.openedTabsTypes={scenes:[],components:[]},this.selectedEditor=null,this.autoReload=!0,this.autoReloadCallback=function(){console.log("auto 1")},this.onSelectedFileType={createNewScene:!1,publishPage:!1},this.$wrapperFilesEl=$("#wrapper-files"),this.$wrapperCodeEditor=$("#wrapper-editor"),this.$wrapperRuntimeEditor=$("#wrapper-runtime-editor"),this.widgetCount=0,this._isClosingAllTabs=!1,this._isExitingEditor=!1,this.fileId=1,this.reloadedRuntimeEditor=0,this.assets={image:[],video:[],sound:[],widget:[],style:[],script:[],font:[]},this.copiedWidgets={widgets:{},animationsToPaste:{},animations:{},tabName:""},this.animationsBackwardsCompatibility={idsToClasses:[]},this.animationBelongsTo="scene",this.currentOpenedTabs=[],this.classNamesCount=0,this.isBasicPanelOpen=!0,this.detachedAmnimationsHTML=null,this.detachedSceneHTML=null,this.sceneSettings={}}return e.prototype.init=function(){this.preferences=editor_settings_1.default.defaultPreferences,this._displayToolbar(),this._displayEditMenu(),this._displayMenu(),this._tabsHandlers(),this._attachMouseCoordsHandlers(),this.initVexFlashMessages()},e.prototype.attachEditorHandlers=function(){var e=this;this.onsave=function(e,t){"widgets/"===this.openFiles[this.selectedEditor].tab.originalFullPath&&(e="widgets/"+e),engine.call("Save",e,t)},this.onExportWidget=function(e,t){return this.EXPORTING_WIDGET=!1,engine.call("ExportWidget",e,t)},this.onreload=function(e){engine.call("Reload",e)},this.onclose=function(e){this.syncTabs(),engine.call("Close",e)},this.onLaunchUrl=function(e){engine.call("LaunchURL",e)},this.oncloseEditor=function(){engine.call("CloseEditor")},this.onopen=function(){engine.call("OpenFile")},this.listDirectory=function(e,t,n){return engine.call("ListDirectory",e,t,n)},this.openAsset=function(e){var t=e.path,n=e.name,i=e.content;return i?engine.trigger("LoadFile",n,i):engine.call("OpenAsset",t)},this.pickAsset=function(t,n){var i=e.environmentProperties.DefaultExtensions[n].map(function(e){return"*."+e}).join(";");return i="Coherent files ("+i+";):"+i+";",engine.call("PickAssetWithExtensions",t,n,i)}},e.prototype.attachBrowserHandlers=function(){var e=this;System.import("uiresources/one.html!text").then(function(t){e.openFile(t,"MainUI.html")})},e.prototype.buildTestScene=function(e,t){function n(){i=setTimeout(function(){return o.openFiles[o.selectedEditor].runtimeEditor.undoRedoScene("redo"),0===o.openFiles[o.selectedEditor].redo.length?s.resolve():n()},50)}var i,o=this,s=$.Deferred();return this.openFiles[this.selectedEditor].redo=e,n(),s.promise()},e.prototype.runCommands=function(e,t){function n(){i=setTimeout(function(){if(o.openFiles[o.selectedEditor].runtimeEditor.undoRedoScene("redo"),0===o.openFiles[o.selectedEditor].redo.length){o.openFiles[o.selectedEditor].runtimeEditor.exportScene();var e=o.openFiles[o.selectedEditor].file;return o.openFiles[o.selectedEditor].runtimeEditor.runtimeLoad(e,{sceneSave:!0}).then(function(e){var n=o.rebuildUserHTML(e),r=o.cleanupHtmlExport(n).replace(/\r/g,"").trim(),l=t.originalFile;return System.import(l+"!text").then(function(e){var t=e.replace(/\r/g,"").trim();clearTimeout(i),t!==r?console.error("functional test failed!"):console.log("functional test passed!"),s.resolve(t===r),a(t,r)})})}return n()},50)}var i,o=this,s=$.Deferred();this.openFiles[o.selectedEditor].redo=e;var a=function(e,t){System.import("bower_components/jsdiff/diff.min").then(function(n){for(var i=n.diffWordsWithSpace(e,t),o=[],s="",a=0;a<i.length;a++)s+="%c"+i[a].value,i[a].removed?o.push("color: red"):i[a].added?o.push("color: green"):o.push("color: grey");console.log.apply(console,[].concat(s,o))})};return n(),s.promise()},e.prototype._attachMouseCoordsHandlers=function(){document.addEventListener("mousemove",function(e){window.mouseCoordsX=e.pageX,window.mouseCoordsY=e.pageY},!1)},e.prototype.widgetEditingHandlers=function(){var e=this.openFiles[this.selectedEditor].tab.tabWidgetState.editWidget;return $(".btn-export-widget").toggle(!e),$(".btn-createWidget-scene").toggle(!e),$(".widgets-content").toggle(!e),this},e.prototype.adjustPreferences=function(){var e=this;if(this.globalEditorInfo.backend!==enums_1.default.Backends.Debug&&this.globalEditorInfo.backend!==enums_1.default.Backends.Website)var t,n,i=engine.call("prefs.get","preferences").result.couiEnvironment,o=vex.dialog.open({closeOnOverlayClick:!0,contentClassName:"modal-about",message:"Environment is "+i+". If changed the editor will be reset!",buttons:[$.extend({},vex.dialog.buttons.NO,{text:"Ok",click:function(){t=!0,o.data().vex.value=!1,vex.close(o.data().vex.id)}}),$.extend({},vex.dialog.buttons.NO,{text:"Cancel",click:function(){t=!1,o.data().vex.value=!1,vex.close(o.data().vex.id)}})],afterOpen:function(o){t=!1;var s=document.querySelector("#vex-preferences-set"),a=e.importHtmlTemplate(s),r=a.querySelector("#environment-dropdownlist"),l=["GT","Hummingbird"];l.splice(l.indexOf(i),1),l.unshift(i),$(r).kendoDropDownList({dataSource:l,animation:!1}),(n=a.querySelector("[aria-activedescendant]")).id="new-editor-environment-set",o.append(a)},callback:function(o){if(t){var s=$("#"+n.id).find("#environment-dropdownlist").data("kendoDropDownList").span[0].textContent;i!==s&&e.changeEngineEnv(s)}}});else vex.dialog.alert({closeOnOverlayClick:!0,contentClassName:"modal-about",message:"Environment preference settings are not available in the Web!"})},e.prototype.tabEdited=function(e,t){var n=w2ui.tabs.tabs,i=t||this.selectedEditor;i=i.replace("editor","");for(var o=0;o<n.length;o++){var s=n[o];if(s.id.replace("tab","")===i){var a=s.text.replace(/()\*+/g,"");s.caption=s.text=e?"*"+a:a,w2ui.tabs.refresh("tab"+i);break}}},e.prototype.refreshTab=function(){var e=this.selectedEditor,t=this.openFiles[e],n=t.runtimeEditor;this.handleFileContent(JSON.stringify(n.scene),t.tab.filename,e,!1,!1)},e.prototype.wasTabEdited=function(e){for(var t=w2ui.tabs.tabs,n=e.replace("editor",""),i=0;i<t.length;i++){var o=t[i];if(o.id.replace("tab","")===n)return-1!==o.text.indexOf("*")}},e.prototype._tabsHandlers=function(){var e=this;$("#tabs").w2tabs({name:"tabs",tabs:[],onClose:function(n){var i="editor"+n.object["data-id"],o=e.openFiles[i],s=o.tab.filename,a=o.tab.state;if(!s.endsWith(".component")&&o.components&&0!==o.components.state.opened.length)return e.closeTabsInOrder(n.target),void n.preventDefault();var r=!0;if(a!==t.safelyClosable&&e.wasTabEdited(i)){var l=[$.extend({},vex.dialog.buttons.NO,{text:"Save",click:function(){d.data().vex.value=!0,vex.close(d.data().vex.id)}}),$.extend({},vex.dialog.buttons.NO,{text:"Discard",click:function(){d.data().vex.value=!1,vex.close(d.data().vex.id)}}),$.extend({},vex.dialog.buttons.NO,{text:"Cancel",click:function(){d.data().vex.value="cancel",vex.close(d.data().vex.id),e._isClosingAllTabs=!1}})];!0===e._isExitingEditor&&l.splice(2,1);var d=vex.dialog.open({contentClassName:"modal-about save-modal",message:"Do you want to save "+s+" ?",buttons:l,afterOpen:function(){r=!1},callback:function(o){if("cancel"!==o){if(o)return e.openFiles[i].tab.state=t.pendingClose,e.save(s,e.openFiles[i].file.valueOf(),null,i),void n.preventDefault();e.clearTab(i,n)}}})}r?setTimeout(function(){e.clearTab(i,n)},100):n.preventDefault()},onClick:function(t){var n=t.object["data-id"],i="editor"+n,o=e.openFiles[i];i===e.selectedEditor&&e.PENDING_SCENE_LOAD||(e.PENDING_SCENE_LOAD=!0,engine.call("SetCurrentSceneURL",e.openFiles[i].tab.filePath),e._isClosingAllTabs||(window.CURRENT_FILE=o.tab.filename,document.body.dispatchEvent(new Event("turnOnLoadingScreen"))),window.requestAnimationFrame(function(){$(".editor").hide(),$("#"+i).show();var t=o.file.valueOf();document.body.dispatchEvent(new CustomEvent("coui.tab.change")),e.selectedEditor=i,"html"===o.tab.fileExtension&&(e.usesSceneEditor(t)||e.photoshopExport(t))||"component"===o.tab.fileExtension?(e.handleFileContent(t,o.tab.filename,i,!1,!1),e._initTabsTooltip(n,o.tab.filename)):(e.$wrapperRuntimeEditor.hide(),e.$wrapperCodeEditor.show(),document.body.dispatchEvent(new Event("couiEditorIsReadyForUse")))}))}})},e.prototype.initSceneConfigVex=function(){var e=this,t="";System.import("templates/editor/scene_create_new.hbs!text").then(function(e){t=e}),$(window).on("createNewScene",function(){var n=[$.extend({},vex.dialog.buttons.NO,{text:"OK",click:function(){e.PENDING_SCENE_LOAD=!1,e.sceneSettings={backgroundColor:$(".init-scene-background-picker").data("kendoColorPicker").value(),width:$(".init-aspect-ratio-width-custom").val(),height:$(".init-aspect-ratio-height-custom").val(),type:$("select.init-scene-aspect-ratio").val()};var t=e.sceneSettings,n=t.type,o=t.width,s=t.height,a=function_helpers_1.default.getSceneSizeByType(n,o,s);e.globalEditorInfo.backend===enums_1.default.Backends.Debug||e.globalEditorInfo.backend===enums_1.default.Backends.Website?e.createNewTestScene(!1,{style:{backgroundColor:e.sceneSettings.backgroundColor},sceneSize:a}):engine.call("ShowFileDialog",{__Type:"FileDialogConfig",extensions:[".html"],dialogName:"Save New Scene As",initDirectory:"",fileMustExist:!1,isOpenFile:!1,allowMultiselect:!1}),i.data().vex.value=!0,vex.close(i.data().vex.id)}}),$.extend({},vex.dialog.buttons.NO,{text:"Cancel",click:function(){e.PENDING_SCENE_LOAD=!0,i.data().vex.value=!1,vex.close(i.data().vex.id)}})],i=vex.dialog.open({contentClassName:"modal-about",message:"New file",buttons:n,afterOpen:function(n){var i=e.Handlebars.compile(t)(enums_1.default.newScene);n.append(i);var o=n.find(".init-scene-aspect-ratio");o.kendoDropDownList({});var s=n.find(".init-scene-background-picker"),a=n.find(".init-aspect-ratio-custom");s.kendoColorPicker({buttons:!1,value:"rgba(255, 255, 255, 0)",opacity:!0}),o.on("change",function(){"aspectRatio_custom"===$(this).val()?a.show():a.hide()})}})})},e.prototype.syncTabs=function(){var e=this,t=w2ui.tabs.tabs,n=Object.keys(this.openFiles);if(t.length!==n.length)for(var i=t.map(function(e){return e.path+e.text.replace("*","")}),o=n.map(function(t){return e.openFiles[t].tab.filePath+e.openFiles[t].tab.filename.replace("*","")}),s=0;s<i.length;s++)-1===o.indexOf(i[s])&&w2ui.tabs.remove(t[s].id)},e.prototype.clearTab=function(e,t){var n=this,o=$("#"+e),s=this.openFiles[e],a=s.tab.filename,r=w2ui.tabs.tabs;if(a.endsWith(".component")){var l=this.openFiles[this.selectedEditor].tab.tabWidgetState.instanceOf||s.tab.tabWidgetState.instanceOf;this.openFiles[l].components.clearOpenedData(e)}if(delete i[e],localStorage.removeItem(e),w2ui.tabs.active===t.target&&r.length>1){var d=(n._getActiveTabIndex()+1)%r.length;if(this._isClosingInOrder&&this.__mainSceneIdToBeClosed){var c=this.__mainSceneIdToBeClosed;0!==this.openFiles[this.__mainSceneIdToBeClosed].components.state.opened.length&&(c=this.openFiles[this.__mainSceneIdToBeClosed].components.state.opened[0]);var u=c.replace("editor","tab");this.focusFileOnClose(o,u)}else this.focusFileOnClose(o,r[d].id)}else o.remove();delete this.openFiles[e],void 0!==this.onclose&&this.onclose(a),this._isClosingAllTabs&&setTimeout(this.closeAllTabs.bind(n),100),this._isClosingInOrder&&setTimeout(this.closeTabsInOrder.bind(n),100),0===r.length&&this.$wrapperCodeEditor.hide()},e.prototype.buildHTML=function(e,t){var n=document.createElement("div");return n.className="temp-holder",n.innerHTML=e,this.buildJSON(n,t)},e.prototype._getActiveTabIndex=function(){for(var e=w2ui.tabs.tabs,t=0;t<e.length;t++)if(e[t].id===w2ui.tabs.active)return t;return e.length-1},e.prototype.focusFileOnClose=function(e,t){e.hide(),e.remove(),w2ui.tabs.click(t)},e.prototype.updateSceneAssets=function(e){var t=!1;this.globalEditorInfo.backend!==enums_1.default.Backends.Debug&&this.globalEditorInfo.backend!==enums_1.default.Backends.Website||(t=!0);for(var n=0;n<e.length;n++)if(e[n].isFile&&"meta"!==e[n].url.split(".").pop()&&("FileEntry"!==e[n].__Type&&"FEditorFileEntry"!==e[n].__Type||(e[n].__Type=function_helpers_1.default.getFileType(e[n].url)),e[n].__Type)){e[n].name||(e[n].name=e[n].url.replace(/\//gm,"\\"));var i=e[n].url.split("\\").join("/");e[n].url=t?"uiresources/"+i:i,this.assets[e[n].__Type].push(e[n])}if(this.selectedEditor){var o=this.openFiles[this.selectedEditor].components.components;for(var s in o)this.assets.widget.push({__Type:"widget",isFile:!1,name:s,url:""})}},e.prototype.rebuildRuntimeEditor=function(e,t,n,i){var o=this;document.body.dispatchEvent(new CustomEvent("coui.editor.rebuild")),$("#wrapper-runtime-editor *").each(function(){$(this).unbind(),$(this).off("blur").off("focus").off("focusin").off("focusout").off("resize").off("scroll").off("click").off("dbclick").off("mousedown").off("mouseup").off("mousemove").off("mouseover").off("mouseout").off("mouseenter").off("mouseleave").off("change")}),this.$wrapperCodeEditor.hide(),this.$wrapperRuntimeEditor.show(),this.initRuntimeEditorHtml(i).then(function(){o.createRuntimeEditor(e,t,i)})},e.prototype.cleanCoherentTags=function(e){var t;return e&&(t=e.replace(/((<style[^<]*.CSS Animations Start([\s\S]*?)CSS Animations End*[^>]*<\/style>)[\s\S]*?)/g,"").replace(/((<script[^<]*.Aspect Ratio Start([\s\S]*?)Aspect Ratio End*[^>]*<\/script>)[\s\S]*?)/g,"").trim()),t},e.prototype.rebuildUserHTML=function(e,t,n){void 0===t&&(t=""),void 0===n&&(n=!1);var i,o,s=/<!-- Coherent Editor Start -->([\s\S]*)<!-- Coherent Editor End -->/,a=this.openFiles[this.selectedEditor],r=[],l=[],d="";return a.tab.originalHTML&&(i=a.tab.originalHTML.split(s)),""!==t&&Object.keys(a.components.components).length>0?(d=a.components.registerComponents(),o=a.tab.originalHTML):""!==t||n||!i||i[0]===enums_1.default.defaultHTML.top&&i[3]===enums_1.default.defaultHTML.bottom||(o=a.tab.originalHTML.replace(enums_1.default.componentWrapper,"").replace(enums_1.default.componentRegister,"")),o&&""!==o?l=o.split(s):(l[0]=enums_1.default.defaultHTML.top,l[2]=enums_1.default.defaultHTML.bottom),r.push(this.cleanCoherentTags(n?enums_1.default.defaultHTML.top:l[0]),e,t,d,this.cleanCoherentTags(n?enums_1.default.defaultHTML.bottom:l[2])),r.join("")},e.prototype.adjustSavedContent=function(e,t){for(var n=JSON.parse(e),i=n.animationClasses,o=Object.keys(i),s=0;s<o.length;s++){var a=o[s];i[a].animationsData["-webkit-filter"]&&this.prepareFilterAnimationToExport(i,a),i[a].animationsData.transform&&this.prepareTransformAnimationToExport(i,a)}for(var r=function(e){if(n.animations[e.id]){var t=n.animations[e.id].className;n.animations[e.id][t]=n.animationClasses[t]}var i=e.boxShadow;!i||"0px"!==i.blurRadius||"rgb(0, 0, 0)"!==i.color&&"#000"!==i.color||"0px"!==i.horizontalLength||""!==i.insetOutset||"0px"!==i.spreadRadius||"0px"!==i.verticalLength||delete e.boxShadow,""===e.className&&delete e.className},l=0;l<n.widgets.length;l++){var d=n.widgets[l];if(t.boxShadowAndClasses){r(d);for(var c=0;c<d.children.length;c++)r(d.children[c])}t.textarea&&"textarea"===n.widgets.type&&delete n.widgets[s].styles.webkitUserSelect}return JSON.stringify(n)},e.prototype.prepareFilterAnimationToExport=function(e,t){var n=e[t].animationsData["-webkit-filter"];e[t].animationsData["-webkit-filter"]={};var i=Object.keys(n)[0];if(i){n[i].name=n[i].name.split("_"),n[i].name[2]="combined",n[i].name=n[i].name.join("_"),e[t].animationsData["-webkit-filter"].combined=n[i];for(var o=e[t].keyframes["-webkit-filter"],s=Object.keys(o).filter(function(e){return e}),a={},r=0;r<s.length;r++)for(var l=Object.keys(o[s[r]]),d=0;d<l.length;d++)a[l[d]]?a[l[d]].push(o[s[r]][l[d]]):a[l[d]]=[o[s[r]][l[d]]];for(var c=Object.keys(a),u=[],p=0;p<c.length;p++)u.push(this.openFiles[this.selectedEditor].runtimeEditor.Keyframes.TimelineScrub.performTimelineScrub(null,Number(c[p]),t,!0,"-webkit-filter"));for(p=0;p<u.length;p++){a[c[p]]=[];for(var f=0;f<u[p].length;f++)a[c[p]].push({group:"-webkit-filter",property:u[p][f].key,time:{seconds:c[p]},values:[u[p][f].value]})}var h=$.extend(!0,{},a[c[0]][0]);h.values[0]="",h.time.seconds="";var m;m=c.reduce(function(e,t){return e[t]=$.extend(!0,{},h),e[t].time.seconds=parseInt(t),e},{});for(var g=0;g<c.length;g++){var v=a[c[g]].map(function(e){return"dropShadow"===e.property?e.values[0].trim():e.property+"("+e.values[0].trim()+")"}).join(" ");m[c[g]].property="-webkit-filter",m[c[g]].values[0]=m[c[g]].values[0]+v}e[t].keyframes["-webkit-filter"]={},e[t].keyframes["-webkit-filter"].combined=m}},e.prototype.prepareTransformAnimationToExport=function(e,t){var n=e[t].animationsData.transform;e[t].animationsData.transform={};var i=!1;n["transform-origin"]&&(i=!0,e[t].animationsData.transform["transform-origin"]=n["transform-origin"],delete n["transform-origin"]);var o=Object.keys(n)[0];if(o){n[o].name=n[o].name.split("_"),n[o].name[2]="combined",n[o].name=n[o].name.join("_"),e[t].animationsData.transform.combined=n[o];for(var s=e[t].keyframes.transform,a=Object.keys(s).filter(function(e){return"transform-origin"!==e}),r={},l=0;l<a.length;l++)for(var d=Object.keys(s[a[l]]),c=0;c<d.length;c++)r[d[c]]?r[d[c]].push(s[a[l]][d[c]]):r[d[c]]=[s[a[l]][d[c]]];for(var u=Object.keys(r),p=[],f=0;f<u.length;f++)p.push(this.openFiles[this.selectedEditor].runtimeEditor.Keyframes.TimelineScrub.performTimelineScrub(null,Number(u[f]),t,!0,"transform"));for(f=0;f<p.length;f++){r[u[f]]=[];for(var h=0;h<p[f].length;h++)r[u[f]].push({group:"transform",property:p[f][h].key,time:{seconds:u[f]},values:[p[f][h].value]})}var m=$.extend(!0,{},r[u[0]][0]);m.values[0]="",m.time.seconds="";var g;g=u.reduce(function(e,t){return e[t]=$.extend(!0,{},m),e[t].time.seconds=parseInt(t),e},{}),r=function_helpers_1.default.reorderTransform(r);for(var v=0;v<u.length;v++){var b=r[u[v]].map(function(e){return e.property+"("+e.values[0].trim()+")"}).join(" ");this.preferences.couiEnvironment===editor_settings_1.default.environment.Hummingbird&&(b=function_helpers_1.default.rebuildTransformForHb(b)),g[u[v]].property="transform",g[u[v]].values[0]=g[u[v]].values[0]+b}i?(i=e[t].keyframes.transform["transform-origin"],e[t].keyframes.transform={},e[t].keyframes.transform["transform-origin"]=i):e[t].keyframes.transform={},e[t].keyframes.transform.combined=g}},e.prototype.getExtension=function(e,t){return e.endsWith(".component")?enums_1.default.extensions.component:this.openFiles[t].tab.fileExtension},e.prototype.save=function(e,t,n,i){return __awaiter(this,void 0,void 0,function(){var o,s,a,r,l,d,c,u,p,f,h=this;return __generator(this,function(m){switch(m.label){case 0:return o=i||this.selectedEditor,s=this.openFiles[o],a=this.getExtension(e,o),r=s.tab.filePath,l=e.replace(/.*[\\\/]/,""),d=null,c=null,s.runtimeEditor&&(d=s.runtimeEditor.Timeline,0!==(c=d.pinCurrentSeconds)&&d.setPinheadPosition(null,0),this.EXPORTING_WIDGET||(t=JSON.stringify(s.runtimeEditor.scene))),a===enums_1.default.extensions.html&&s.runtimeEditor&&(t=this.adjustSavedContent(t,{boxShadowAndClasses:!0,textarea:!0})),a!==enums_1.default.extensions.component?[3,1]:(u=s.tab.tabWidgetState.instanceOf||o,this.openFiles[u].components.save(l,t),this.onSaveCompleted(l,l),this.tabEdited(!0,u),[3,6]);case 1:return this.EXPORTING_WIDGET?[3,5]:void 0===o?[2]:n?(this.saveFile(r+l,t,o),this.setPinheadPosition(c),[2]):this.isJson(s.file)?(p=this.environmentProperties,[4,s.components.buildComponentExportHTML()]):[3,3];case 2:return f=m.sent(),Object.keys(s.components.components).length>0&&(f=p.WRAPPER_COMPONENTS_MARK_START+f+p.WRAPPER_COMPONENTS_MARK_END),s.runtimeEditor.runtimeLoad(t,{sceneSave:!0}).then(function(e){var t=h.rebuildUserHTML(e,f),n=h.cleanupHtmlExport(t);h.saveFile(r+l,n,o),h.setPinheadPosition(c)}).catch(function(e){console.log(e.message)}),[3,4];case 3:this.saveFile(r+l,t,o),this.setPinheadPosition(c),m.label=4;case 4:return[3,6];case 5:s.runtimeEditor.runtimeLoad(t,{widgetSave:!0}).then(function(e){var t=h.rebuildUserHTML(e,"",h.EXPORTING_WIDGET),n=h.cleanupHtmlExport(t);h.saveFile(r+l,n,o),h.setPinheadPosition(c)}).catch(function(e){console.log(e.message)}),m.label=6;case 6:return[2]}})})},e.prototype.setPinheadPosition=function(e){var t=this.openFiles[this.selectedEditor];null!==e&&t&&t.runtimeEditor&&this.openFiles[this.selectedEditor].runtimeEditor.Timeline.setPinheadPosition(null,e)},e.prototype.previewStop=function(e,t){var n=$("#scene");clearTimeout(e.playAnimation),e.iframe.remove(),e.iframe=void 0,t&&(n[0].style.backgroundColor=t),n.append(this.detachedSceneHTML),function_helpers_1.default.rekickDomWebkitMasks(),this.detachedSceneHTML=null},e.prototype.spriteChangeState=function(e,t){var n,i;t?(n="play",i="stop"):(n="stop",i="play"),e.addClass("btn-"+n),e.removeClass("btn-"+i)},e.prototype.toggleVideoPlayback=function(e,t){for(var n=e.length,i=0;i<n;i++)t?e[i].play():e[i].pause()},e.prototype.getMaxVideoLength=function(e){for(var t=0,n=e.length,i=0;i<n;i++)1e3*e[i].duration>t&&(t=1e3*e[i].duration);return t},e.prototype.preview=function(e,t,n){var i=this,o=this.selectedEditor;if(void 0!==o){var s=$("#preview-scene-button > .fa"),a=$("#preview-animation-button > .fa"),r=this.openFiles[o].runtimeEditor;r.iframe||this.setPinheadPosition(0),t=this.adjustSavedContent(JSON.stringify(r.scene),{boxShadowAndClasses:!0,textarea:!0});var l=JSON.parse(t),d=l.scripts;l.scripts=[];var c=$("#scene"),u=r.scene.style.backgroundColor;r.iframe?(this.spriteChangeState(a,!0),this.spriteChangeState(s,!0),i.previewStop(r,u),r.highlightSelectedEl(null,r.currentElementsSelection)):r.runtimeLoad(JSON.stringify(l)).then(function(e){var t=r.scene.animations,o=function_helpers_1.default.getObjects(t,"seconds").map(function(e){return parseFloat(e)}),l=Math.max.apply(Math,o);if(l>0){var p,f,h=r.scene.sceneSize.width,m=r.scene.sceneSize.height,g=/((<script[^<]([\s\S]*?)[^>]*<\/script>)[\s\S]*?)/g;if(i.globalEditorInfo.backend===enums_1.default.Backends.Debug||i.globalEditorInfo.backend===enums_1.default.Backends.Website){f=/&quot;/gi;var v="url("+window.location.origin+"/";p=e.replace(f,""),p=p.replace(/url\(/gm,v).replace(/(<link\s+(?:[^>]*?\s+)?href=")([^"]*)"/g,"$1"+window.location.origin+'/uiresources/$2"')}else f=/coui:\/\/uiresources\/editor\//gi,p=e.replace(f,"");for(var b=g.exec(p);b;)d.push(b[0]),b=g.exec(p);p=p.replace(g,"");var y=$('<iframe id="preview" sandbox="allow-same-origin allow-scripts allow-forms" width="'+h+'" height="'+m+'"></iframe>');r.clearSelectedElements();var E=$("#scene style").detach();i.detachedSceneHTML=$("#scene").html(),c[0].style.backgroundColor=null,$("#scene *").detach(),E.prependTo(c),c.append(y),i.spriteChangeState(a,!1),i.spriteChangeState(s,!1),y.ready(function(){var e=document.getElementById("preview").contentWindow,t=y.contents();t.find("html").css("overflow","hidden").append(p);var n=t.find("video");r.evalScripts(e,d),r.displayVideos(n),r.iframe=y}),r.Timeline.animatePinhead(l,n),n===enums_1.default.animationPreviewType.preview&&(r.playAnimation=setTimeout(function(){i.previewStop(r,u),i.spriteChangeState(a,!0),i.spriteChangeState(s,!0),r.highlightSelectedEl(null,r.currentElementsSelection)},l))}})}else console.error("File id for "+e+" cannot be found!")},e.prototype.saveFile=function(e,t,n,i){var o=this;if(this.EXPORTING_WIDGET){var s=function_helpers_1.default.getFileAndPath(e).filename;this.onExportWidget(s,t).then(function(){return o.openFiles[o.selectedEditor].runtimeEditor._initAssetsKendoToolbar()})}else{if(this.openFiles[n].tab.pendingSave)return;this.openFiles[n].tab.pendingSave=!0,!0===this.autoReload&&this._reload(this.autoReloadCallback),this.onsave&&i!==enums_1.default.extensions.component&&this.onsave(e,t)}},e.prototype.onSaveCompleted=function(e,n){var i=this.getIdForFile(e);if(void 0!==i){var o="editor"+i;if(this.openFiles[o].tab.pendingSave=!1,this.tabEdited(!1,o),e!==n&&this.renameTab(e,n),this.openFiles[o].tab.state===t.pendingClose){this.openFiles[o].tab.state=t.safelyClosable;var s="tab"+i;w2ui.tabs.animateClose(s)}}},e.prototype._reload=function(e){this.onreload&&this.onreload(e)},e.prototype.isItPublishPage=function(e){return e.indexOf(this.environmentProperties.ORIGINAL_SOURCE_SCENE_PATH)>-1&&e.indexOf(this.environmentProperties.ORIGINAL_SOURCE_SCENE_PATH_END)>-1},e.prototype.getOriginSceneUrl=function(e){var t=/<!-- Original scene path -->([\s\S]*)<!-- Original scene path end -->/;if(t.exec(e))return t.exec(e)[1].replace(/<!--([\s\S]*?)-->/gi,"$1").trim();console.error("there is no comment marks")},e.prototype.getFileEditorProps=function(e,t){var n=e.exec(t),i="";return n&&(i=n[0].match(/"(.*)"/)[1]),i},e.prototype.changeEngineEnv=function(e){this.preferences.couiEnvironment=e,this.savePreferences(),this._isExitingEditor=!0,engine.trigger("AboutToClose")},e.prototype.savePreferences=function(){engine.call("prefs.set","preferences",this.preferences),engine.call("prefs.save")},e.prototype.showEnvironmentWarning=function(e,t){var n=this;vex.dialog.confirm({message:"You are running the Coherent Editor in a "+t+" environment, but the file that you are trying to open has been created in "+e+" environment. Would you like to start the editor in "+e+" environment? ",contentClassName:"modal-about",callback:function(t){delete n.openFiles[n.selectedEditor],t&&n.changeEngineEnv(e)}})},e.prototype.compareSettings=function(e,t){var n={EDITOR_VERSION:enums_1.default.EDITOR_VERSION,couiEnvironment:enums_1.default.couiEnvironment},i=this.getFileEditorProps(n[e],t);i&&i!==this.preferences[e]&&this.showEnvironmentWarning(i,this.preferences[e])},e.prototype.openFile=function(e,t){var n=/\/*([^/]*\.([^.]*))$/.exec(t),i=n[n.length-1],o=t.replace(/[^\/\\]*$/,""),s=o;switch("widgets"===function_helpers_1.default.rootFolder(o)&&(o=o.split(/[\/\\]/).slice(1).join("/")),i){case"js":i=enums_1.default.extensions.js;break;case"css":i=enums_1.default.extensions.css;break;case"html":i=enums_1.default.extensions.html;break;case"component":i=enums_1.default.extensions.component}var a=t.replace(/^.*[\\\/]/,""),r=function_helpers_1.default.openPathHandler(e,o);if(i===enums_1.default.extensions.html||i===enums_1.default.extensions.component)if(this.usesSceneEditor(e)||i===enums_1.default.extensions.component){var l=this.getFileEditorProps(enums_1.default.couiEnvironment,e)||null;if(this._addRuntimeEditor(r,a,i,o),this.compareSettings("couiEnvironment",e),this.$wrapperCodeEditor.hide(),l&&l!==this.preferences.couiEnvironment&&i!==enums_1.default.extensions.component)return void document.body.dispatchEvent(new Event("editorLoaded"))}else this._addFileContent(e,a,i);else this._addFileContent(e,a,i);document.body.dispatchEvent(new CustomEvent("coui.tab.change")),this.selectedEditor="editor"+this.fileId,this.openFiles[this.selectedEditor].tab.originalFullPath=s,this._addTab(a,o),this.fileId++,this.PENDING_WIDGET_LOAD&&(this.openFiles[this.selectedEditor].tab.tabWidgetState.editWidget=!0,this.PENDING_WIDGET_LOAD=!1)},e.prototype.forceClose=function(e){this.tabEdited(!1,e);var t=e.replace("editor","tab");w2ui.tabs.animateClose(t)},e.prototype.closeTabsInOrder=function(e){var t=this.selectedEditor;if(e&&(t=e.replace("tab","editor")),this._isClosingInOrder=!0,null===this.__mainSceneIdToBeClosed){this.__mainSceneIdToBeClosed=t;var n=this.openFiles[t].components.state.opened[0],i=$("#"+t),o=n.replace("editor","tab");return this.focusFileOnClose(i,o),void w2ui.tabs.animateClose(o)}if(t=this.__mainSceneIdToBeClosed,0!==this.openFiles[t].components.state.opened.length){var s=w2ui.tabs.tabs[this._getActiveTabIndex()];w2ui.tabs.animateClose(s.id)}else{this._isClosingInOrder=!1,this.__mainSceneIdToBeClosed=null;var a=t.replace("editor","tab");this.openFiles[t].tab.filename,this.openFiles[t].file;window.requestAnimationFrame(function(){w2ui.tabs.animateClose(a)})}},e.prototype.closeAllTabs=function(){if(0!==w2ui.tabs.tabs.length){this._isClosingAllTabs=!0;var e=w2ui.tabs.tabs[this._getActiveTabIndex()];w2ui.tabs.animateClose(e.id)}else this.oncloseEditor()},e.prototype.focusFile=function(e){w2ui.tabs.click("tab"+this.getIdForFile(e))},e.prototype.focusCUIFile=function(e){var t=e.replace("editor","");w2ui.tabs.click("tab"+t)},e.prototype.getSceneFileAndPath=function(e){return{path:this.openFiles[e].tab.originalFullPath,filename:this.openFiles[e].tab.filename}},e.prototype.sceneExist=function(e){for(var t in this.openFiles){var n=this.openFiles[t].tab.originalFullPath,i=this.openFiles[t].tab.filename,o=n?n.replace(/\\/g,"/"):"";if(i.endsWith(".component")){for(var s=this.openFiles[this.selectedEditor].components.state.opened,a=0;a<s.length;a++)if(this.openFiles[s[a]].tab.filename===e)return!0}else if(o+i===e)return!0}return!1},e.prototype.getIdForFile=function(e){var t=this;for(var n in t.openFiles){var i=this.getSceneFileAndPath(n).path.replace(/\\/g,"/"),o=this.getSceneFileAndPath(n).filename.replace(/\\/g,"/"),s=e.replace(/\\/g,"/");if("widgets/"===i&&o===s||i+o===s)return~~n.replace("editor","")}},e.prototype.renameTab=function(e,t){var n=this.getIdForFile(e);if(void 0!==n){var i="editor"+n;this.openFiles[i].tab.filename=t;var o=this.openFiles[i].runtimeEditor;o&&o.setOpenedFile(t);for(var s=w2ui.tabs.tabs,a=0;a<s.length;a++)if(s[a]["data-id"]===n){s[a].caption=s[a].text=t,w2ui.tabs.refresh("tab"+n);break}}},e.prototype._createTabData=function(e,n){return{filePath:"",filename:e,fileExtension:n,state:t.open,pendingSave:!1,tabWidgetState:{importedWidget:!1,editWidget:!1,instanceOf:null,createNewWidget:!1},scrollIndex:{rightPanel:0,assetLibrary:0},assetsLibraryStates:{image:{expanded:!0},video:{expanded:!0},widget:{expanded:!0},script:{expanded:!0},style:{expanded:!0},font:{expanded:!0}},snapOn:!1}},e.prototype._addFileContent=function(e,t,n){var i=this;$(".editor").hide(),"string"!=typeof e&&(e=e.toString());var o="editor"+this.fileId,s=document.createElement("pre");s.id=o,s.className="editor",s.dataset.id=this.fileId,this.$wrapperFilesEl.append(s),this.openFiles[o]={},this.openFiles[o].file=ace.edit(s),this.openFiles[o].file.setTheme("ace/theme/twilight"),this.openFiles[o].file.getSession().setMode("ace/mode/"+n),this.openFiles[o].file.insert(e);var a=this.openFiles[o].file.getSession();a.getUndoManager().reset(),a.on("change",function(){i.tabEdited(!0)}),this.openFiles[o].file.valueOf=function(){return this.getValue()}.bind(this.openFiles[o].file),this.openFiles[o].tab=this._createTabData(t,n),s.style.display="block"},e.prototype._addRuntimeEditor=function(e,t,n,i){var o=this.isJson(e)?JSON.parse(e):{},s="editor"+this.fileId;this.openFiles[s]={},this.openFiles[s].createdNow=o.createdNow||!1,this.openFiles[s].file=e,this.openFiles[s].tab=this._createTabData(t,n),this.openFiles[s].tab.filePath=i,this.openFiles[s].pendingRebuild=!1,this.openFiles[s].widgetTypesCounter={},this.openFiles[s].widgetClassCounter={},this.openFiles[s].components=new components_1.default,this.selectedEditor=s,this.isJson(e)||this.openFiles[s].components.load(e)},e.prototype._addTab=function(e,t){w2ui.tabs.add({id:"tab"+this.fileId,"data-id":this.fileId,path:t||"",caption:e,closable:!0}),w2ui.tabs.click("tab"+this.fileId),this._initTabsTooltip(this.fileId,e)},e.prototype._initTabsTooltip=function(e,t){function n(){var t=i.openFiles["editor"+e].tab.tabWidgetState.instanceOf,n=i.openFiles[t].tab.filePath||"",o=i.openFiles[t].tab.filename;$("#tabs_tabs_tab_tab"+e).append('<span class="tab-tooltip">belongs&nbsp;to:&nbsp;'+n+o+"</span>"),$("#tabs_tabs_tab_tab"+e).hover(function(){$(this).find(".tab-tooltip").show()},function(){$(this).find(".tab-tooltip").hide()})}var i=this;t.endsWith(".component")&&(null!==this.openFiles["editor"+e].tab.tabWidgetState.instanceOf?n():($("body").off("__componentInstanceSet"),$("body").on("__componentInstanceSet",function(){n()})))},e.prototype._getCurrentFileId=function(){return document.querySelector('.editor[style*="display: block"]').id},e.prototype._displayEditMenu=function(){System.import("lib/hbs/editing_menu.hbs!text").then(function(e){$("#edit-menu").append(e)})},e.prototype._displayMenu=function(){var e=this;$(".btn-new-file").off("click"),$(".btn-new-file").on("click",function(){$(window).trigger("createNewScene")}),$(".btn-open-file").off("click"),$(".btn-open-file").on("click",function(){e.onopen()}),$(".btn-publish-file").off("click"),$(".btn-publish-file").on("click",function(){var t=e.openFiles[e.selectedEditor];t&&t.runtimeEditor.publishScene()}),$(".btn-save-file").off("click"),$(".btn-save-file").on("click",function(){var t=e.openFiles[e.selectedEditor];if(t){var n=t.tab.filename,i=t.file.valueOf();e.save(n,i)}}),$(".btn-quit-file").off("click"),$(".btn-quit-file").on("click",function(){engine.trigger("AboutToClose")}),$(".btn-pref-file").off("click"),$(".btn-pref-file").on("click",function(){e.adjustPreferences()}),$(".btn-documentation").on("click",function(t){t.preventDefault(),e.onLaunchUrl(enums_1.default.Links.documentation)}),$(".btn-tutorials").on("click",function(t){t.preventDefault(),e.onLaunchUrl(enums_1.default.Links.tutorials)}),$(".btn-community-forums").on("click",function(t){t.preventDefault(),e.onLaunchUrl(enums_1.default.Links.communityForum)}),$(".btn-editor-roadmap").on("click",function(t){t.preventDefault(),e.onLaunchUrl(enums_1.default.Links.roadmap)}),$(".bnt-shortcut").on("click",e.onshortcut),$(".btn-about").on("click",e.onabout.bind(e))},e.prototype.onshortcut=function(){System.import("lib/hbs/shortcuts.hbs!text").then(function(e){vex.dialog.open({contentClassName:"modal-shortcuts",message:"Keyboard Shortcuts",buttons:[$.extend({},vex.dialog.buttons.NO,{text:"Close"})],afterOpen:function(t){t.append(e)}})})},e.prototype.onabout=function(){var e=this;vex.dialog.open({contentClassName:"modal-about version",message:"About",buttons:[$.extend({},vex.dialog.buttons.NO,{text:"Ok"})],afterOpen:function(t){var n=e.EDITOR_VERSION.join(".");t.append("Coherent Editor version: "+n)}})},e.prototype.onundo=function(){var e=this.openFiles[this.selectedEditor];e&&(e.runtimeEditor?e.runtimeEditor.undoRedoScene("undo"):e.file.undo())},e.prototype.onredo=function(){var e=this.openFiles[this.selectedEditor];e&&(e.runtimeEditor?e.runtimeEditor.undoRedoScene("redo"):e.file.redo())},e.prototype.delete=function(){var e=this.openFiles[this.selectedEditor];e&&e.runtimeEditor.removeMultipleWidgets()},e.prototype._displayToolbar=function(){var e=this;$("#toolbar-code-editor").w2toolbar({name:"toolbar",items:[{type:"button",id:"save-file",caption:"Save",icon:"fa fa-save"},{type:"break",id:"break1"},{type:"button",id:"undo",caption:"Undo",icon:"fa fa-undo"}],onClick:function(t){var n;switch(t.target){case"open-file":e.openFile("Pehso","coherent_view_1.css");break;case"save-file":n=e._getCurrentFileId(),e.save(e.openFiles[n].tab.filename,e.openFiles[n].file.valueOf());break;case"reload-file":e._reload(e.openFiles[n].tab.filename);break;case"auto-reload":!0!==t.item.checked?e.autoReload=!0:e.autoReload=!1;break;case"undo":n=e._getCurrentFileId(),e.openFiles[n].file.undo()}}})},e.prototype.kendoDestroyEvents=function(){var e=$("#horizontal-timeline-splitter"),t=$("#horizontal-inner"),n=$("#vertical"),i=$("#horizontal"),o=$("#animation-toolbar");o.length>0&&o.data("kendoToolBar")&&o.data("kendoToolBar").destroy(),e.length>0&&e.data("kendoSplitter")&&e.data("kendoSplitter").destroy(),t.length>0&&t.data("kendoSplitter")&&t.data("kendoSplitter").destroy(),n.length>0&&n.data("kendoSplitter")&&n.data("kendoSplitter").destroy(),i.length>0&&i.data("kendoSplitter")&&i.data("kendoSplitter").destroy();var s=$("#borderColor-picker"),a=$("#background-picker"),r=$("#boxShadow-picker"),l=$("#color-picker");s.length>0&&s.remove(),a.length>0&&a.remove(),r.length>0&&r.remove(),l.length>0&&l.remove();var d=$("#left-pane select");d.length>0&&d.remove();var c=$("#create-element-tabs");c.length>0&&c.remove();var u=$(".dragging-point");u.length>0&&(u.removeData("kendoDraggable"),u.removeData("role"),u.unbind("mousedown"),u.unbind("selectstart"),u.remove())},e.prototype.niceScrollDestroyEvents=function(){$(".info-widgets").length>0&&$(".info-widgets").remove()},e.prototype.initRuntimeEditorHtml=function(e){var t=this;return this.kendoDestroyEvents(),this.niceScrollDestroyEvents(),Promise.all([System.import("lib/hbs/runtime_editor_wrapper.hbs!text"),System.import("lib/animations/hbs/timeline.hbs!text")]).then(function(n){var i=n[0],o=n[1],s=t.Handlebars.compile(i),a=t.Handlebars.compile(o);t.$wrapperRuntimeEditor.html(s),$(".animations-panel").html(a),t.$wrapperRuntimeEditor.find(".runtime-editor").attr("id",e),$("#horizontal-timeline-splitter").kendoSplitter({panes:[{collapsible:!1,min:"380px",max:"500px",size:"400px"},{collapsible:!1}],resize:function(){var e=$(this.element[0]),n=$("#middle-pane").height();e.height(n),e.find(".k-splitbar").height(n),e.find(".info-section").height(n),$("#middle-pane").hide().show(0),t.resizeTimelineVertical()}})})},e.prototype.createRuntimeEditor=function(e,t,n){var i,o=this;system_config_1.default(),System.import("./lib/runtime_editor").then(function(s){i=new s.default;var a=o.openFiles[n];a.runtimeEditor=i;var r=JSON.parse(localStorage.getItem(n));null!==r?(a.undo=r[n].undo,a.redo=r[n].redo):(a.undo=[],a.redo=[]),o.globalEditorInfo.backend!==enums_1.default.Backends.Debug||o.globalEditorInfo.backend!==enums_1.default.Backends.Website?(i.init(e,t,n),i.setOpenedFile(a.tab.filename)):i.init(e,t,n),o.initScenePanZoom(i),o.initKendoSplitter(),o.initTimelineScroll(),o.initKendoToolbar(i),o.initRightPanelItem(i),o.initEditingEventHandlers(i),o.initSceneEventHandlers(i),o.widgetEditingHandlers(),key_handlers_1.default.attachkeyHandlersRuntimeEditor(i),$("#horizontal-timeline-splitter").css("transform","rotate(360deg)"),i._sceneActionState.initialLoad=!1,i.exportScene(),o.assets.widget=[],o.listDirectory("widgets","(.html)",!1).then(function(e){o.updateSceneAssets(e),i._initAssetsKendoToolbar()});var l=o.openFiles[o.selectedEditor].tab.filePath;if(engine.call("SetCurrentSceneURL",l),o.classNamesCount+=function_helpers_1.default.numKeys(o.openFiles[o.selectedEditor].runtimeEditor.scene.animationClasses),o.missingWidgets.length>0&&!o.PENDING_WIDGET_EXPORT){var d="Could not load: <br />";o.missingWidgets.map(function(e){d+=e+" <br />"}),$("#coui-editor").trigger("vexFlashMessage",[d]),o.missingWidgets=[],o.PENDING_WIDGET_EXPORT=!1}window.requestAnimationFrame(function(){document.body.dispatchEvent(new Event("editorLoaded"))})})},e.prototype.initVexFlashMessages=function(){$("#coui-editor").on("vexFlashMessage",function(e,t,n){void 0===n&&(n=!1);var i=t||enums_1.default.Messages.duplicateAnimationsTabToTab,o=vex.dialog.open({closeOnOverlayClick:!0,contentClassName:"modal-about",message:i,unsafeContent:"html-escape",buttons:[$.extend({},vex.dialog.buttons.NO,{text:"Ok",click:function(){o.data().vex.value=!1,vex.close(o.data().vex.id)}})],afterOpen:function(){n&&setTimeout(function(){o.data().vex&&vex.close(o.data().vex.id)},3e3)}})})},e.prototype.importHtmlTemplate=function(e){return(void 0===e.content&&this.globalEditorInfo.backend===enums_1.default.Backends.Standalone||this.globalEditorInfo.backend===enums_1.default.Backends.Unreal?e.cloneNode(!0):document.importNode(e.content,!0)).firstElementChild},e.prototype.checkComponentNameDuplication=function(e){var t=this.openFiles[this.selectedEditor].components.components;for(var n in t){var i=n;if(console.log(e,i),i===e)return!0}return!1},e.prototype.checkWidgetNameDuplication=function(e){return this.listDirectory("widgets","(.html)",!1).then(function(t){for(var n=0;n<t.length;n++){var i=t[n].url.split("\\")[1];if(console.log(e,i),i===e)return!0}return!1})},e.prototype.initExportWidgetHandler=function(){var e=this.selectedEditor,t=this.openFiles[e];if(t){var n=this,i=t.runtimeEditor,o=!1,s=i.currentParentElementsSelection;s=s.filter(function(e){return null!==e});for(var a=0;a<s.length;a++)if(i.isWidget(s[a])||!i.isTopLevel(s[a])){o=!0;break}if(s.length>=1&&!o)var r=vex.dialog.open({closeOnOverlayClick:!0,contentClassName:"modal-about",message:"",buttons:[$.extend({},vex.dialog.buttons.NO,{text:"Ok",click:function(){function e(e){var n=$(".vex-dialog-button.vex-first").hasClass("pending-widget-name-replace");e&&!n?($(r).find(".vex-dialog-message").text(enums_1.default.warnMessages.nameDuplication),$(".vex-dialog-button.vex-first").text("replace").addClass("pending-widget-name-replace"),$(t).one("input",function(){$(".vex-dialog-button.vex-first").text("OK").removeClass("pending-widget-name-replace"),$(r).find(".vex-dialog-message").text("")}),event.preventDefault()):-1!==s.search(i)?($(r).find(".vex-dialog-message").text("Invalid widget name! The following characters : \\\"' ,/.:|&!\\n\\r\\t@#(){}[]=;^%$`~ are not supported in widget names!"),t.value="",event.preventDefault()):0===s.trim().length?($(r).find(".vex-dialog-message").text("Invalid widget name."),t.value="",event.preventDefault()):function_helpers_1.default.validateId(s)?(o=!1,r.data().vex.value=!1,vex.close(r.data().vex.id)):($(r).find(".vex-dialog-message").text(enums_1.default.warnMessages.idValidationWarning("widget name")),t.value="",event.preventDefault())}var t=document.getElementById("give-widget-name"),i=/(\/|\$|\%|\^|\;|\=|\'|\|\,|\.|\&|\!|\\n|\\r|\\t|\@|\#|\(|\)|\{|\}|\[|\]|\`|<|>|:|"|\||\\|\?|\~|\*)/g,s=t.value;$("#export-widget-type").is(":checked")||!1?e(n.checkComponentNameDuplication(s+".component")):n.checkWidgetNameDuplication(s+".html").then(function(t){e(t)})}}),$.extend({},vex.dialog.buttons.NO,{text:"Cancel",click:function(){o=!0,vex.close(r.data().vex.id)}})],afterOpen:function(e){o=!0;var t=this,i=document.querySelector("#vex-create-widget"),s=n.importHtmlTemplate(i);n.globalEditorInfo.backend===enums_1.default.Backends.Hummingbird||"Hummingbird"===n.preferences.couiEnvironment?(s.querySelector('input[type="checkbox"].convert-units-to-percent').parentNode.remove(),s.querySelector('input[type="checkbox"].export-widget-type').parentNode.remove()):(s.querySelector('input[type="checkbox"].convert-units-to-percent').id="convert-units-to-percent",s.querySelector('input[type="checkbox"].export-widget-type').id="export-widget-type");var a=s.querySelector('input[type="text"]');a.id="give-widget-name",$(a).on("keydown",function(e){e.keyCode===enums_1.default.Keys.enter&&t.buttons[0].click()}),e.append(s)},callback:function(t){if(!o){var a=$("#convert-units-to-percent").is(":checked")||!1,r=$("#export-widget-type").is(":checked")||!1,l=document.getElementById("give-widget-name").value,d=l;r?(d+=".component",n.EXPORTING_COMPONENT=!0):(d+=".html",n.EXPORTING_WIDGET=!0,n.PENDING_WIDGET_EXPORT=!0),i.Timeline.setPinheadPosition(0,0);var c=n.cleanWidgetName(l),u=i.scene,p=$.extend(!0,{},u),f=$.extend(!0,{},n.environmentProperties.DefaultWidget),h=p.widgets;f.id=n.generateRandomId(c),f.type="widget";for(var m=[],g=[],v=0;v<h.length;v++){var b=h[v].id;s.indexOf(b)>=0?m.push(h[v]):g.push(h[v])}f.geometry=i.getWidgetElementSelectionSize(m,a),m.length>=1?(f.children=m,u.widgets=[f]):u.widgets=m,i.createUndoRedoNewWidget(f,r),g.push(u.widgets[0]),p.widgets=g,n.openFiles[e].tab.tabWidgetState.importedWidget=!0,u.widgets[0].widgetkit=d,u.animationClasses=i.transferAnimations(p,m,d),n.openFiles[e].tab.tabWidgetState.createNewWidget=!0;var y=JSON.parse(JSON.stringify(u));y.styles=[],y.scripts=[],y.widgets=[y.widgets[0]],y.sceneEvents.sceneLoad="",y.style.backgroundColor="rgba(255, 255, 255, 0)",r?n.openFiles[e].components.create(d,JSON.stringify(y)):n.save(d,JSON.stringify(y)),r&&n.replaceContentOfOpenedComponent(d,y,e),n.handleFileContent(JSON.stringify(p),n.openFiles[e].tab.filename,e,!1,!1),n.EXPORTING_COMPONENT=!1}}});else vex.dialog.alert({contentClassName:"modal-about",message:"Invalid selection! Please select at least two top level non-widget UI elements."})}},e.prototype.replaceContentOfOpenedComponent=function(e,t,n){for(var i=0;i<this.openFiles[n].components.state.opened.length;i++){var o=this.openFiles[n].components.state.opened[i];if(this.openFiles[o].tab.filename===e)return void(this.openFiles[o].file=JSON.stringify(t))}},e.prototype.initSceneEventHandlers=function(e){var t=this;$("#right-pane").off("scroll"),$("#right-pane").on("scroll",function(t){e.tab.scrollIndex.rightPanel=$(t.target).scrollTop()}),$("#assets-bar-holder").off("scroll"),$("#assets-bar-holder").on("scroll",function(t){e.tab.scrollIndex.assetLibrary=$(t.target).scrollTop()}),$("#save-scene").off("click"),$("#save-scene").on("click",function(){var e=t.openFiles[t.selectedEditor],n=e.tab.filename;t.save(n,e.file.valueOf())}),$("#preview-animation-button").off("click"),$("#preview-animation-button").on("click",function(){var n="";n=t.openFiles[t.selectedEditor].runtimeEditor.repeatAnimation?enums_1.default.animationPreviewType.endlessPreview:enums_1.default.animationPreviewType.preview,e.preview(n)}),$("#prev-animation-button").off("click"),$("#prev-animation-button").on("click",function(){e.Timeline.setToPreviousKeyframe()}),$("#next-animation-button").off("click"),$("#next-animation-button").on("click",function(){e.Timeline.setToNextKeyframe()}),$("#first-animation-button").off("click"),$("#first-animation-button").on("click",function(){e.Timeline.setToFirstKeyframe()}),$("#last-animation-button").off("click"),$("#last-animation-button").on("click",function(){e.Timeline.setToLastKeyframe()}),$("#auto-keyframe-button").off("click"),$("#auto-keyframe-button").on("click",function(){$(this).toggleClass("active"),e.switchAutoKeyframe()}),$("#repeat-animation-button").off("click"),$("#repeat-animation-button").on("click",function(){$(this).toggleClass("active"),e.switchRepeatAnimation()}),$("#filter-animation-button").off("click"),$("#filter-animation-button").on("click",function(){e._sceneActionState.primaryAction="new action",t.preferences.timeline.filterTimelineWidgets?t.preferences.timeline.filterTimelineWidgets=!1:t.preferences.timeline.filterTimelineWidgets=!0,t.savePreferences(),e.Timeline.resetAllTimeline(),e.Animations.loadTimeline(e.scene.animationClasses)}),$(".animations-panel a").on("click",function(){e.blurOutTextInputs()}),$("#scene-aspect-ratio").off("change"),$("#scene-aspect-ratio").on("change",function(n){var i=n.target.value;e._setUndoRedoCommandsFill({aspectRatio:{type:e.scene.sceneSize.type}},"new action"),e.setAspectRatio(i),"aspectRatio_custom"!==i?window.requestAnimationFrame(function(){t.focusCUIFile(t.selectedEditor)}):document.querySelector("#aspect-ratio-custom").classList.remove("is-hidden")}),$("#resetZoom").off("click"),$("#resetZoom").on("click",function(){$("#scene").panzoom("setMatrix","matrix(1, 0, 0, 1, 0, 0)"),e.tab.sceneTransformMatrix=[1,0,0,1,0,0],e.changeSceneScale(1)})},e.prototype.initEditingEventHandlers=function(e){var t=this;$(".btn-undo-scene").off("click"),$(".btn-undo-scene").on("click",function(e){e.preventDefault(),t.onundo()}),$(".btn-redo-scene").off("click"),$(".btn-redo-scene").on("click",function(e){e.preventDefault(),t.onredo()}),$(".btn-copy-widgets").off("click"),$(".btn-copy-widgets").on("click",function(t){t.preventDefault(),$(this).hasClass("disabled")||(e._sceneActionState.primaryAction="new action",e.copyWidgets())}),$(".btn-paste-widgets").off("click"),$(".btn-paste-widgets").on("click",function(t){t.preventDefault(),e.cloneWidget()}),$(".btn-createWidget-scene").off("click"),$(".btn-createWidget-scene").on("click",function(e){e.preventDefault(),$(this).hasClass("disabled")||t.initExportWidgetHandler()}),$(".btn-delete-widget").off("click"),$(".btn-delete-widget").on("click",function(e){e.preventDefault(),$(this).hasClass("disabled")||t.delete()})},e.prototype.initScenePanZoom=function(e){var t,n=this,i=e.tab,s=$("#sceneScale"),a=$(".sceneZoomButton"),r=$("#top-scene-holder"),l=$("#slider-zoom-percent");i.sceneTransformMatrix?t="matrix("+i.sceneTransformMatrix.join(" ,")+")":(t="matrix(1, 0, 0, 1, 0, 0)",i.sceneTransformMatrix=[1,0,0,1,0,0]);var d=function(e,t){$(e).addClass("k-state-active"),$(t).removeClass("k-state-active")};e.sceneWrapper.panzoom("destroy"),$("#scene").panzoom("destroy");var c=$("#scene-wrapper").panzoom({disablePan:!0,startTransform:t,minScale:.3,maxScale:1.7,cursor:"default",$set:$("#scene")});$("#scene").panzoom({disablePan:!0});var u=i.sceneTransformMatrix[0];e.changeSceneScale(u),$("html").off("keydown"),$("html").on("keydown",function(t){t.which===enums_1.default.Keys.alt&&(t.preventDefault(),e.isInPanningMode=!0,d("#pan-tool","#select-tool"),c.panzoom("option",{disablePan:!1}),$(".onoff").css("z-index",-1),n.panningCursor(!0))}),$("html").off("keyup"),$("html").on("keyup",function(t){t.which!==enums_1.default.Keys.alt||o||(t.preventDefault(),e.isInPanningMode=!1,d("#select-tool","#pan-tool"),c.panzoom("option",{disablePan:!0}),n.panningCursor(!1),$(".onoff").css("z-index",999),i.sceneTransformMatrix=c.panzoom("getMatrix").map(function(e){return parseFloat(e)}))}),$(window).off("blur"),$(window).on("blur",function(){o||(e.isInPanningMode=!1,d("#select-tool","#pan-tool"),n.panningCursor(!1),c.panzoom("option",{disablePan:!0}))}),c.parent().on("mousewheel.focal",function(t){t.preventDefault();var n=t.delta||t.originalEvent.wheelDelta,o=n?n<0:t.originalEvent.deltaY>0;c.panzoom("zoom",o,{animate:!1,increment:.1,focal:t}),i.sceneTransformMatrix=c.panzoom("getMatrix").map(function(e){return parseFloat(e)});var s=i.sceneTransformMatrix[0];e.changeSceneScale(s)});var p=$("#scene-property");p.off("mousedown"),p.on("mousedown",function(){e.WidgetSelection.detachHandlers()}),p.off("mouseup mouseleave"),p.on("mouseup mouseleave",function(){e.WidgetSelection.attachHandlers()}),s.off("input change"),s.on("input change",function(t){t.preventDefault(),e._dragFlag=!1;var n={clientX:r.offset().left+r.width()/2,clientY:r.offset().top+r.height()/2},o=t.target.value;o=(o-30)/140*1.4+.3,c.panzoom("zoom",o,{disablePan:!1,focal:n}),e.changeSceneScale(o),i.sceneTransformMatrix=c.panzoom("getMatrix").map(function(e){return parseFloat(e)})}),a.off("mousedown"),a.on("mousedown",function(t){t.preventDefault();var n="incrementSceneZoom"!==this.id,o={clientX:r.offset().left+r.width()/2,clientY:r.offset().top+r.height()/2};c.panzoom("zoom",n,{disablePan:!1,increment:.025+1e-4*Math.random(),focal:o}),i.sceneTransformMatrix=c.panzoom("getMatrix").map(function(e){return parseFloat(e)});var s=i.sceneTransformMatrix[0];e.changeSceneScale(s)}),l.off("mousedown"),l.on("mousedown",function(){var e=$(this),t=e.val();"%"===t[t.length-1]&&e.val(t.slice(0,-1))}),l.off("blur keyup"),l.on("blur keyup",function(t){event.preventDefault();var n=$(this),o=parseFloat(n.val());if("blur"===t.type||t.keyCode===enums_1.default.Keys.enter){var s={clientX:r.offset().left+r.width()/2,clientY:r.offset().top+r.height()/2};o>170?o=170:o<30&&(o=30),o=(o-30)/140*1.4+.3,c.panzoom("zoom",o,{disablePan:!1,focal:s}),i.sceneTransformMatrix=c.panzoom("getMatrix").map(function(e){return parseFloat(e)}),t.keyCode===enums_1.default.Keys.enter&&n.blur(),e.changeSceneScale(o)}}),i.sceneTransformMatrix=c.panzoom("getMatrix").map(function(e){return parseFloat(e)})},e.prototype.initKendoSplitter=function(){var e=this;$("#horizontal").kendoSplitter({orientation:"horizontal",panes:[{resizable:!1,collapsible:!0,size:"280px"}],resize:function(){$("#left-pane").height($("#left-pane").height()+15)}}),$("#vertical").kendoSplitter({orientation:"vertical",panes:[{collapsible:!0},{collapsible:!0,min:"100px",size:"35%"}],collapse:function(t){"middle-pane"===t.pane.id&&($(".info-widgets").getNiceScroll().hide(),e.detachedAmnimationsHTML=$(".animations-panel").detach())},expand:function(t){null!==e.detachedAmnimationsHTML&&($("#middle-pane").append(e.detachedAmnimationsHTML),e.detachedAmnimationsHTML=null,e.resizeTimelineVertical(),$(".info-widgets").getNiceScroll().show())},resize:function(){$("#middle-pane").hide().show(0),$("#assets-bar .files-cont").hide().show(0),$("#horizontal-timeline-splitter").data("kendoSplitter")&&$("#horizontal-timeline-splitter").data("kendoSplitter").trigger("resize"),e.resizeTimelineVertical()}}),$("#horizontal-inner").kendoSplitter({orientation:"horizontal",panes:[{collapsible:!0},{collapsible:!0,min:"270px",size:"270px"}]}),this.resizeTimelineVertical()},e.prototype.resizeTimelineVertical=function(){var e=this.openFiles[this.selectedEditor].runtimeEditor,t=$(".timeline-wrap").height();$(".widgets-keyframes").height(t-62),$(".info-widgets").height(t-62),$(".pin-height").height(t-42),$("#assets-bar .files-cont").hide().show(0),$(".info-widgets").getNiceScroll().resize();var n=$(".scene-properties-holder").height(),i=$(".scene-hierarchy-holder").height(),o=$("#right-pane").height()-(n+i);$("#assets-bar").is(":visible")?(o=o<enums_1.default.assetLabelsEntryHeight?enums_1.default.assetLabelsEntryHeight:o,$(".scene-library-holder").css("height",o),$("#assets-bar").css("height",o-enums_1.default.assetsLibraryLabelSize),$("#assets-bar-holder").css("height",o-enums_1.default.assetLibraryPreviewSize),e&&e.virtualList.isInstantiated()&&e.virtualList.refresh()):$(".scene-library-holder").css("height",enums_1.default.assetsLibraryLabelSize)},e.prototype.initTimelineScroll=function(){$(".info-widgets").niceScroll({cursoropacitymin:1,cursorwidth:10,cursorborder:"1px solid #262626",cursorborderradius:0,cursorcolor:"#1C1C1C"}),$(".info-widgets").scroll(function(e){var t=$(".info-widgets").scrollTop();$(".widgets-keyframes").scrollTop(t)})},e.prototype.createModalSceneEditor=function(e,t){void 0===e.scene.sceneEvents&&(e.scene.sceneEvents={sceneLoad:""});var n=e.scene.sceneEvents[t];e.createModalJsEditor(t,"sceneEvents",n)},e.prototype.initKendoToolbar=function(e){var t=this,n=function(n){"pan-tool"===n.id?e.isInPanningMode=!0:"select-tool"===n.id&&(e.isInPanningMode=!1),o=e.isInPanningMode,t.panningCursor(e.isInPanningMode),e.scenePanning()};$(".k-list-container").remove(),$("#animation-toolbar").kendoToolBar({items:[{type:"button",spriteCssClass:"btn-first-keyframe",id:"first-animation-button"},{type:"button",spriteCssClass:"btn-previous-keyframe",id:"prev-animation-button"},{type:"button",spriteCssClass:"fa btn-play",id:"preview-animation-button"},{type:"button",spriteCssClass:"btn-next-keyframe",id:"next-animation-button"},{type:"button",spriteCssClass:"btn-last-keyframe",id:"last-animation-button"},{type:"button",spriteCssClass:"ic-autokeyframe",id:"auto-keyframe-button",class:"btn-autokeyframe",togglable:!0},{type:"button",spriteCssClass:"ic-repeat-animation",id:"repeat-animation-button",class:"btn-repeat-animation",togglable:!0},{type:"button",spriteCssClass:"fa fa-filter btn-filter-animation",id:"filter-animation-button",class:"btn-filter-animation",togglable:!0,selected:t.preferences.timeline.filterTimelineWidgets}]}),$("#toolbar").kendoToolBar({items:[{type:"button",spriteCssClass:"fa fa-file",id:"new-file",click:function(){$(window).trigger("createNewScene")}},{},{type:"button",spriteCssClass:"fa fa-folder-open",id:"open-file",click:function(){t.onopen()}},{},{type:"button",spriteCssClass:"fa fa-save",id:"save-scene"},{type:"button",spriteCssClass:"fa fa-external-link",id:"publish-scene",click:function(){e.publishScene()}},{type:"button",spriteCssClass:"fa fa-undo",id:"undo-scene",click:function(){e.undoRedoScene("undo"),t.autoTriggerUndoRedo("undo")}},{},{type:"button",spriteCssClass:"fa fa-repeat",id:"redo-scene",click:function(){e.undoRedoScene("redo"),t.autoTriggerUndoRedo("redo")}},{type:"button",spriteCssClass:"fa fa-magnet",id:"snap-scene",togglable:!0,selected:t.openFiles[t.selectedEditor].tab.snapOn,toggle:function(e){var n=t.openFiles[t.selectedEditor].tab.snapOn;t.openFiles[t.selectedEditor].tab.snapOn=!n,$(e.target).toggleClass("k-state-active",!n)}},{type:"button",spriteCssClass:"fa fa-mouse-pointer",id:"select-tool",togglable:!0,group:"scene-buttons",selected:!0,toggle:n},{type:"button",spriteCssClass:"fa fa-hand-paper-o",id:"pan-tool",togglable:!0,group:"scene-buttons",toggle:n},{type:"button",imageUrl:"./img/resetZoom.png",id:"resetZoom"},{type:"button",imageUrl:"./img/help.png",id:"help",click:function(){t.onLaunchUrl(enums_1.default.Links.documentation)}}]}),t.setToolbarTitles()},e.prototype.initRightPanelItem=function(e){this.initKendoDropDownsInRightPane(),this.initKendoToolbarsInRightPane(e),this.initInputSupportForGTInRightPane(e),this.initSceneBackgroundColorPicker(e)},e.prototype.initKendoDropDownsInRightPane=function(){return $("#right-pane select").kendoDropDownList({animation:!1}),this},e.prototype.initKendoToolbarsInRightPane=function(e){var t=this;$("#scene-events").kendoToolBar({items:[{type:"splitButton",overflow:"never",text:"Events",id:"scene-events-split-button",menuButtons:[{text:"on scene load",id:"sceneLoad",click:function(n){t.createModalSceneEditor(e,n.id)}}]}]})},e.prototype.initInputSupportForGTInRightPane=function(e){e.inputNumbersFocusInOutHandler("right-pane")},e.prototype.initSceneBackgroundColorPicker=function(e){$("#scene-background-picker").kendoColorPicker({buttons:!1,value:e.scene.getStyleProperty("backgroundColor"),opacity:!0,close:function(t){e.setSceneStyleProperty("backgroundColor",t.sender.element.val())},select:function(t){e.scene.applyStyleProperty("backgroundColor",t.sender.element.val())}})},e.prototype.autoTriggerUndoRedo=function(e){var t=this.openFiles[this.selectedEditor],n=t.runtimeEditor,i=t.redo[0],o=t.undo[0]&&t.undo[0][0].deleteComponent;if(i&&(i[0].deleteElement&&i[0].deleteElement.createWidget.isNewWidget||i[0].deleteComponent)&&n.undoRedoScene(e),i&&i[0].createElement&&o){var s=i[0].createElement.deleteWidget;s.widgetkit&&s.widgetkit.endsWith(".component")&&n.undoRedoScene(e)}},e.prototype.createNewScene=function(e,t){var n=function_helpers_1.default.getFileAndPath(t).path;engine.call("SetCurrentSceneURL",n);var i=t,o=Object.keys(this.openFiles).length,s=$.extend(!0,{},enums_1.default.newScene);if(e.createdNow=!0,e&&$.extend(!0,s,e),o>0)for(var a in this.openFiles){var r=this.getSceneFileAndPath(a),l=r.path,d=r.filename;l.replace(/\//g,"\\")+d===t&&this.clearTab(a,event)}this.openFile(JSON.stringify(s),i),$("#loader-wrapper").show(),this.save(i,JSON.stringify(s),!0),newFileCounter++,this.openFiles[this.selectedEditor].tab.sceneID=this.fileId,this.openFiles[this.selectedEditor].tab.pendingSave=!1},e.prototype.createNewTestScene=function(e,t){var n="";n=e?e+".html":"*new"+newFileCounter+".html";var i=$.extend(!0,{},enums_1.default.newScene);t&&$.extend(!0,i,t),this.openFile(JSON.stringify(i),n),newFileCounter++},e.prototype.generateRandomId=function(e){return this.incrementWidgetTypesCounter(e),e+this.getWidgetCounterForType(e)},e.prototype.generateClassName=function(){var e=this.openFiles[this.selectedEditor],t=enums_1.default.animationClassPrefix+"animation"+this.classNamesCount++,n=e.tab.filename.endsWith(".component");if(e.runtimeEditor.scene.animationClasses[t])return this.generateClassName();for(var i=0;i<e.components.state.opened.length;i++){var o=e.components.state.opened[i];if(this.openFiles[o].runtimeEditor.scene.animationClasses[t])return this.generateClassName()}if(n){var s=e.tab.tabWidgetState.instanceOf,a=this.openFiles[s];if(JSON.parse(a.file).animationClasses[t])return this.generateClassName()}return t},e.prototype.incrementWidgetTypesCounter=function(e){var t=this.openFiles[this.selectedEditor];t.widgetTypesCounter=t.widgetTypesCounter||{},t.widgetTypesCounter[e]||(t.widgetTypesCounter[e]=0);var n=t.widgetTypesCounter[e]+1,i=t.runtimeEditor;if(i)for(;void 0!==i.mappedWidgets[e+n];)t.widgetTypesCounter[e]++,n=t.widgetTypesCounter[e]+1;t.widgetTypesCounter[e]++},e.prototype.getWidgetCounterForType=function(e){return this.openFiles[this.selectedEditor].widgetTypesCounter[e]},e.prototype.cleanupImportedHTML=function(e){var t=/<!-- Register Components Start -->([\s\S]*?)<!-- Register Components End -->/.exec(e);null!==t&&(e=e.replace(t[0],""));var n=/<!-- Wrapper Components Start -->([\s\S]*?)<!-- Wrapper Components End -->/.exec(e);return null!==n&&(e=e.replace(n[0],"")),e},e.prototype.handleFileContent=function(e,t,n,i,o){var s=this,a=t.endsWith(".component"),r=$.Deferred();void 0!==this.openFiles[this.selectedEditor].tab.originalHTML||this.isJson(e)||a||(this.openFiles[this.selectedEditor].tab.originalHTML=this.cleanupImportedHTML(e.valueOf())),i=i||!1,o=o||!1;var l,d,c,u=this.photoshopExport(e),p=/\/\* CSS Animations Start \*\/([\s\S]*?)\/\* CSS Animations End \*\//,f=/\/\* Aspect Ratio Start \*\/([\s\S]*)\/\* Aspect Ratio End \*\//,h=/\/\* Scene Properties Start \*\/([\s\S]*)\/\* Scene Properties End \*\//,m=/<body>([\s\S]*)<\/body>/;if(u){var g=/<!-- Save for Web Slices \([\s\S]+\) -->([\s\S]+)<!-- End Save for Web Slices -->/,v=/<!-- Save for Web Styles \([\s\S]+\) -->([\s\S]+)<!-- End Save for Web Styles -->/;g.exec(e.valueOf())&&v.exec(e.valueOf())&&(l=g.exec(e.valueOf())[1],d=v.exec(e.valueOf())[1],this.addTempStyleHolder(d))}else m.exec(e.valueOf())&&(l=m.exec(e.valueOf())[0]);var b={};if(void 0===l){if(b=JSON.parse(e.valueOf()),this.openFiles[this.selectedEditor].tab.tabWidgetState.importedWidget&&o){var y=b.widgets[0].widgetkit.replace(/.html/,"");y=this.cleanWidgetName(y);var E=this.generateRandomId(y);b.widgets[0].id=E}}else if(u)b=this.buildHTML(l);else{var w=/<!-- Coherent Editor Start -->([\s\S]*)<!-- Coherent Editor End -->/.exec(e.valueOf())[1],_=/<style id="coui_font_faces">([\s\S]*?)<\/style>/.exec(e.valueOf()),S=void 0;_&&(S=_[1]);var k=w.split("<body>")[1];b=this.buildHTML(k,S)}if(h.exec(e)){var x;x=(x=h.exec(e)[1]).match(/{.+}/),(x=JSON.parse(x[0])).style?(b.style=x.style,this.animationBelongsTo=x.sceneType):b.style=x}if(p.exec(e)&&(c=p.exec(e.valueOf())[1]),f.exec(e)){var C;C=(C=f.exec(e)[1]).match(/{.+}/),C=JSON.parse(C[0]),b.sceneSize=C}c&&""!==c&&(b.animationClasses=importCss_1.default.importCss(c));var T=b.widgets[0];this.openFiles[this.selectedEditor].tab.tabWidgetState.importedWidget&&o&&(b=this.extendObj(this.openFiles[this.selectedEditor].runtimeEditor.scene,b));var F=this.openFiles[this.selectedEditor];if(b.widgets&&this.checkWidget(b.widgets)&&!i&&!a)b=this.updateWidget(b),F.tab.tabWidgetState.importedWidget=!0,b instanceof Promise?b.then(function(e){s.animationBackwardsCompatibility(e.widgets),s.loopAnimationsIds(e.animationClasses).then(function(i){e.animationClasses=i,o&&F.runtimeEditor.saveUndoRedoAfterCreateElement(T.id,T),e.animations={},s.rebuildRuntimeEditor(e,i,t,n),r.resolve()})}):(this.animationBackwardsCompatibility(b.widgets),b.animations={},this.rebuildRuntimeEditor(b,b.animationClasses,t,n),r.resolve());else{if(i&&!o)return b;this.animationBackwardsCompatibility(b.widgets),b.animations={},this.rebuildRuntimeEditor(b,b.animationClasses,t,n),r.resolve()}return r.promise()},e.prototype.loopWidgetChildAndGenerateIds=function(e){function t(e){for(var i=0;i<e.length;i++)e[i].id=n.generateRandomId(e[i].type),e[i].children.length>0&&t(e[i].children)}var n=this,i=$.extend(!0,{},e);return t(i.children),i},e.prototype.animationBackwardsCompatibility=function(e){for(var t=this.animationsBackwardsCompatibility.idsToClasses,n=t.length,i=0;i<n;i++)for(var o=0;o<e.length;o++)e[o].id===t[i]&&(function_helpers_1.default.doesClassNameExist(e[o].className,t[i])||(e[o].className=t[i])),e[o].children.length>0&&this.animationBackwardsCompatibility(e[o].children)},e.prototype.loopAnimationsIds=function(e){var t=this.openFiles[this.selectedEditor].runtimeEditor;if(!t)return new Promise(function(t){return t(e||{})});var n=t.scene.animationClasses,i=[];if(this.openFiles[this.selectedEditor].runtimeEditor){for(var o in n){var s=e[o];if(s&&s.belongTo!==n[o].belongTo){!function(){var e=new Promise(function(e){var t=vex.dialog.confirm({closeOnOverlayClick:!0,contentClassName:"modal-about",message:enums_1.default.Messages.overwriteWidgetAnimations,buttons:[$.extend({},vex.dialog.buttons.NO,{text:"Yes",click:function(){vex.close(t.data().vex.id),e("yes")}}),$.extend({},vex.dialog.buttons.NO,{text:"No",click:function(){vex.close(t.data().vex.id),e("no")}})]})});i.push(e)}();break}}i.push(new Promise(function(e){return e("yes")}))}return Promise.all(i).then(function(t){return"yes"===t[0]?$.extend(!0,n,e):n})},e.prototype.cleanupHtmlExport=function(e){var t,n=this,i=e.match(/<script class="global-events">[\s\S]*\/script>/)[0],o=e.split(i);t=this.globalEditorInfo.backend===enums_1.default.Backends.Unreal?/coui:\/\/editor\//gi:/coui:\/\/uiresources\/editor\//gi;var s=o[0].replace(/-webkit-transform/g,"transform").replace(t,""),a=this.openFiles[this.selectedEditor].tab.filePath;return s=s.replace(/(background-image|src|mask-image|-webkit-mask): url\((.*?)\)/gi,function(e,t,i){var o='"'===i[0]?'"':"'";return t+": url("+o+n.handleRelativePath(i)+o+")"}).replace(/src="([coui:\/\/]|.*?)"/gi,function(e,t){var i=t;if("js"!==t.split(".").pop())i=n.handleImageCouiPath(t);else{var o=function_helpers_1.default.getFileAndPath(t).path,s=function_helpers_1.default.getFileAndPath(t).filename;i=function_helpers_1.default.externalFilePathHandler(o,a)+s}return'src="'+i+'"'}).replace(/<link.*href="([coui:\/\/]|.*?)">/gi,function(e,t){var n=function_helpers_1.default.getFileAndPath(t).path,i=function_helpers_1.default.getFileAndPath(t).filename;return'<link rel="stylesheet" type="text/css" class="styles" href="'+(function_helpers_1.default.externalFilePathHandler(n,a)+i)+'">'}).replace(/background-position: initial initial/gi,function(e,t){return"background-position: initial"}).replace(/-webkit-blend-mode/gi,function(e,t){return"mix-blend-mode"}).replace(/font-family: initial;/g,"").replace(/(-webkit-)?mask-size: (.*?);/gi,function(e){return function_helpers_1.default.transformMaskSize(e)}),[s,i,o[1]].join("")},e.prototype.handleImageCouiPath=function(e){var t=this.openFiles[this.selectedEditor].tab.filePath.replace(/\\/g,"/"),n=e.match(/coui:\/\//),i=function_helpers_1.default.getFileAndPath(e),o=i.path,s=i.filename,a=new RegExp("^"+t),r="";if(n&&(o=o.replace(/coui:\/\/uiresources\//,"")),e.match(a))r=o.replace(t,"").replace(/[^\/\\]*$/,"");else for(var l=t.split("/"),d=o.split("/"),c=d.length,u=0;u<c;u++){var p=0;if(l[u]!==d[u]){r="../".repeat(p||l.length-1)+d.join("/");break}l[u]===d[u]&&(d=d.slice(u+1),l=l.slice(u+1),p++)}return r+s},e.prototype.handleRelativePath=function(e){var t=e.replace(/'|"/g,""),n=this.openFiles[this.selectedEditor].tab.filePath,i=function_helpers_1.default.getFileAndPath(t),o=i.path,s=i.filename;return function_helpers_1.default.pathHandler(o,n,t)+s},e.prototype.panningCursor=function(e){var t=$(".panning");e?t.addClass("is-panning"):t.removeClass("is-panning")},e.prototype.buildJSON=function(e,t){void 0===t&&(t="");var n=[],i=e.childNodes,o=$.extend(!0,{},enums_1.default.newScene),s=this.openFiles[this.selectedEditor].tab.filePath;this.renderStyles("imported-styles",e);for(var a in i){var r=i[a];switch(void 0!==r.localName&&null!==r.localName&&"#text"!==r.nodeName&&"SCRIPT"!==r.nodeName&&"LINK"!==r.nodeName&&n.push(r),r.className){case"global-events":o.sceneEvents.sceneLoad=r.innerText;break;case"scripts":var l=function_helpers_1.default.cleanUrls(r.src);o.scripts.push(function_helpers_1.default.assetPathHandler(l,s));break;case"styles":var d=function_helpers_1.default.cleanUrls(r.href);o.styles.push(function_helpers_1.default.assetPathHandler(d,s))}}return t&&(o.fonts=(t.match(/'.*?'/gi)||[]).map(function(e){return e.replace(/'/g,"")})),n.length&&this.buildChildNodes(n,o),o},e.prototype.renderStyles=function(e,t){var n=document.getElementById(e);if(null!==n){for(var i=n.querySelector("style").sheet.cssRules,o=0,s=i.length;o<s;o++){var a=i[o];t.querySelector(a.selectorText).style.cssText+=a.style.cssText}n.parentNode.removeChild(n)}},e.prototype.buildChildNodes=function(e,t){var n;for(var i in e)n=this.childNode(e[i]),t.widgets.push(n)},e.prototype.loopChildNodes=function(e){if(1===e.length)return this.childNode(e[0]);for(var t=[],n=0;n<=e.length-1;n++)t.push(this.childNode(e[n]));return t},e.prototype.updateWidget=function(e){return __awaiter(this,void 0,void 0,function(){var t,n,i,o,s,a,r,l,d;return __generator(this,function(c){switch(c.label){case 0:t="",n=[],i=[],o=this,s=[];for(a in e.widgets)s.push(a);r=0,c.label=1;case 1:return r<s.length?(l=s[r],!e.widgets[l].children.length||e.widgets[l].widgetkit?[3,3]:[4,this.updateWidget(e.widgets[l].children)]):[3,6];case 2:return c.sent(),[3,5];case 3:return e.widgets[l].widgetkit?(d="",d=" "!==e.widgets[l].widgetkit?e.widgets[l].widgetkit:"test",[4,this.fetchWidget(d)]):[3,5];case 4:"missing widget"!==(t=c.sent())&&(n.push(t),i.push(l)),c.label=5;case 5:return r++,[3,1];case 6:return 0!==n.length?[2,Promise.all(n).then(function(t){for(var n=0;n<t.length;n++)"string"==typeof t[n]&&(t[n]=JSON.parse(t[n])),e.animationClasses=$.extend({},e.animationClasses,t[n].animationClasses),e.widgets[i[n]].children=t[n].widgets[0].children,e.widgets[i[n]].widgetkit.endsWith(".component")&&(e.widgets[i[n]]=o.loopWidgetChildAndGenerateIds(e.widgets[i[n]]));return e})]:[2,e]}})})},e.prototype.buildWidgetSceneObjFromHtml=function(e){return this.handleFileContent(e,"load.component",this.selectedEditor,!0,!1)},e.prototype.fetchWidget=function(e){return __awaiter(this,void 0,void 0,function(){var t,n,i,o,s,a,r,l,d,c,u,p;return __generator(this,function(f){switch(f.label){case 0:return t=this,i=new Date,s="component",a=this.openFiles[this.selectedEditor].tab.filename,r=this.openFiles[this.selectedEditor].tab.filePath.replace("widgets/","").replace("editor/selenium/scenes/GT/","").replace("editor/selenium/scenes/General/",""),e.endsWith(".html")&&(s="widget"),l=r+"widgets/"+e,"widget"!==s?[3,2]:(o=this.globalEditorInfo.backend===enums_1.default.Backends.Standalone||this.globalEditorInfo.backend===enums_1.default.Backends.Unreal?l+"?"+i.getTime()+"!text":"uiresources/"+l+"?"+i.getTime()+"!text",[4,this.linkCheck(l.replace(/\//g,"\\"))]);case 1:return(d=f.sent())||a===e?[2,System.import(o).then(function(e){return n=t.handleFileContent(e,t.openFiles[t.selectedEditor].tab.filename,t.selectedEditor,!0,!1)})]:(this.missingWidgets.push(l),[2,"missing widget"]);case 2:if("component"===s)return c=this.openFiles[this.selectedEditor],(u=c.components.components[e])||(u=c.file),p=t.handleFileContent(u,t.openFiles[t.selectedEditor].tab.filename,t.selectedEditor,!0,!1),[2,Promise.resolve(p)];f.label=3;case 3:return[2]}})})},e.prototype.linkCheck=function(e){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(n){switch(n.label){case 0:return[4,this.listDirectory("widgets","(.html)",!1)];case 1:return t=n.sent(),[2,t.some(function(t){return t.url===e})]}})})},e.prototype.checkWidget=function(e){for(var t in e)if(e[t].children.length&&!e[t].widgetkit)this.checkWidget(e[t].children);else if(e[t].widgetkit)return!0;return!1},e.prototype.hasId=function(e,t){return this.isJson(e.file)?function_helpers_1.default.hasInChildren(JSON.parse(e.file).widgets,"id",t):-1!==e.file.indexOf('id="'+t+'"')},e.prototype.toChangeId=function(e,t,n){var i=!1,o=!1;for(var s in e)if(this.isJson(e[s].file)){if(i=this.hasId(e[s],t),!e[s].createdNow)continue;n===s&&(o=this.hasId(e[s],t))}return!(i&&!o)},e.prototype.getChangeIdConditions=function(e,t){var n=!1;e&&(n=this.toChangeId(this.openFiles,e,this.selectedEditor));var i=document.getElementById(e);return{allowAdding:!i||i&&!n,applied:t[this.selectedEditor][e],editing:this.openFiles[this.selectedEditor].tab.tabWidgetState.editWidget}},e.prototype.childNode=function(e){this.widgetCount++;var t,o,s,a=[],r=$.extend(!0,{},this.environmentProperties.DefaultWidget);if(e.children.length&&((s=this.loopChildNodes(e.children))instanceof Array?a=s:a.push(s))," "!==r.type){var l="";l="IMG"===e.nodeName?"image":e.nodeName.toLowerCase(),r.widgetkit?r.type="widget":e.hasAttribute("data-type")?r.type=e.getAttribute("data-type"):r.type=l}i[this.selectedEditor]=i[this.selectedEditor]||{};var d=this.getChangeIdConditions(e.id,i);if(e.id&&d.allowAdding&&!d.applied||d.editing)r.id=e.id,i[this.selectedEditor][e.id]=e.id,this.incrementWidgetTypesCounter(r.type);else{var c;if("widget"===r.type){var u=e.dataset.widgetkit.replace(/.html/,"");u=this.cleanWidgetName(u),c=this.generateRandomId(u)}else c=this.generateRandomId(r.type);r.id=c,n[c]=e.id,i[this.selectedEditor][c]=c}r=build_widget_settings_1.default.buildWidget(r.type,r,e),t=e.dataset;for(var p in t)if("type"===p||"widgetkit"===p)r[p]=t[p]||!0;else if(function_helpers_1.default.isDataBindingTypes(p))this.setWidgetDataBinds(r.dataBindings,p,t[p]);else if(function_helpers_1.default.isEventName(p))if("engineTriggerArguments"===(o=t[p].split("("))[0]||"engineCallArguments"===o[0]||"blueprintFunction"===o[0]){var f=o[1].split(")")[0].split(",");this.setWidgetEvents(r.events,p,o,f)}else r.events[p]={javascriptFunction:t[p]};return a.length&&(r.children=a),r},e.prototype.cleanWidgetName=function(e){e.endsWith(".component")&&(e=e.replace(".component",""));return e.replace(/[,._ ()+\-*&^!?=]/g,"_")},e.prototype.setWidgetDataBinds=function(e,t,n){e[t]={},e[t]=n},e.prototype.setWidgetEvents=function(e,t,n,i){var o=n[0];e[t]={},e[t][o]=i},e.prototype.isJson=function(e){try{JSON.parse(e)}catch(e){return!1}return!0},e.prototype.usesSceneEditor=function(e){return this.isJson(e)||e.indexOf(this.environmentProperties.COMMENT_MARK_START)>-1&&e.indexOf(this.environmentProperties.COMMENT_MARK_END)>-1},e.prototype.photoshopExport=function(e){return this.isJson(e)||e.indexOf(this.environmentProperties.PHOTOSHOP_STYLE_COMMENT_END)>-1&&e.indexOf(this.environmentProperties.PHOTOSHOP_CONTENT_COMMENT_END)>-1},e.prototype.addTempStyleHolder=function(e){var t=document.createElement("div");t.id="imported-styles",t.innerHTML=e,document.body.appendChild(t)},e.prototype.setToolbarTitles=function(){document.getElementById("new-file").title="New file",document.getElementById("open-file").title="Open file",document.getElementById("save-scene").title="Save file",document.getElementById("undo-scene").title="Undo",document.getElementById("redo-scene").title="Redo",document.getElementById("select-tool").title="Select Tool",document.getElementById("pan-tool").title="Pan Scene",document.getElementById("resetZoom").title="Reset zoom",document.getElementById("help").title="Help"},e.prototype.extendObj=function(e,t){var n=function(e,t){var i={};for(var o in t){var s=e[o],a=t[o];"animations"===o?i[o]=$.extend(!0,s,a):s?"object"!=typeof s||a instanceof Array?a instanceof Array?([],i[o]=s.concat(a)):i[o]=s:i[o]=n(s,a):i[o]=a}return i};return n(e,t)},e}();e.Editor=s}(coui=exports.coui||(exports.coui={}));