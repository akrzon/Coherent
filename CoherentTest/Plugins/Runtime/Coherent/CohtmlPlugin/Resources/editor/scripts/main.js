"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var editor_1=require("../scripts/editor"),function_helpers_1=require("lib/function_helpers"),enums_1=require("lib/enums"),editor_settings_1=require("lib/editor_settings"),editor_properties_1=require("lib/editor_properties"),prototype_methods_1=require("../scripts/globals/prototype-methods");prototype_methods_1.default();var key_handlers_1=require("lib/key_handlers"),couiEditor=new editor_1.coui.Editor;exports.default=couiEditor,engine.on("LoadFile",function(e,i){console.log("Loading: "+e),"EmptyUI.html"!==e&&(window.CURRENT_FILE=e,document.body.dispatchEvent(new Event("turnOnLoadingScreen"))),setTimeout(function(){if(couiEditor.isItPublishPage(i)){var t=couiEditor.getOriginSceneUrl(i),n=function_helpers_1.default.getFileAndPath(e).path;return engine.call("SetCurrentSceneURL",n),couiEditor.PENDING_PUBLISH_PAGE_LOAD=!0,void couiEditor.openAsset({path:t})}couiEditor.PENDING_SCENE_LOAD=!1,couiEditor.PENDING_PUBLISH_PAGE_LOAD=!1;try{if(couiEditor.sceneExist(e))return couiEditor.focusFile(e),void console.log("File found. Focusing tab.")}catch(e){window.err=e,console.error("Could not open file: "+e)}try{if("EmptyUI.html"!==e){if(couiEditor.PENDING_PUBLISH_PAGE_LOAD&&""===i)return $("#coui-editor").trigger("vexFlashMessage",[enums_1.default.Messages.cannotFindPublishPage]),void(couiEditor.PENDING_PUBLISH_PAGE_LOAD=!1);couiEditor.openFile(i,e),console.log("File loaded."),couiEditor.PENDING_WIDGET_LOAD&&(couiEditor.openFiles[couiEditor.selectedEditor].tab.tabWidgetState.editWidget=!0,couiEditor.PENDING_WIDGET_LOAD=!1),e.endsWith(".component")&&document.body.dispatchEvent(new Event("__openComponentComplete"))}else document.body.dispatchEvent(new Event("couiEditorIsReadyForUse"))}catch(e){console.error("Could not open file: "+e)}},100)}),engine.on("AboutToClose",function(){couiEditor.closeAllTabs()}),engine.on("FileSaved",couiEditor.onSaveCompleted.bind(couiEditor)),engine.on("SelectedFiles",function(e){if(0!==e.length){var i=e[0].split(/uiresources[\/\\]/i)[1],t=(i.replace(/.*[\\\/]/,""),/.+\\/),n="";new RegExp(t).test(i)&&(n=i.match(t)[0]);var r=n.replace(/\\/g,"/")||"",o=couiEditor.openFiles[couiEditor.selectedEditor];if(couiEditor.onSelectedFileType.publishPage){var l=""+o.tab.filePath+o.tab.filename;if(o.tab.filePath.replace(/\\/g,"/")!==r)return void $("#coui-editor").trigger("vexFlashMessage",[enums_1.default.Messages.cannotSavePublishPage]);var s=function_helpers_1.default.removeSlashes([l,i]);if(s[0]===s[1])return void $("#coui-editor").trigger("vexFlashMessage",[enums_1.default.Messages.duplicationFileName]);var a=o.runtimeEditor,u=couiEditor.adjustSavedContent(JSON.stringify(a.scene),{boxShadowAndClasses:!0,textarea:!0});a.runtimeLoad(u,{publishScene:!0,originalSceneName:o.tab.filename}).then(function(e){var t=couiEditor.rebuildUserHTML(e),n=couiEditor.cleanupHtmlExport(t);couiEditor.saveFile(i,n,couiEditor.selectedEditor),couiEditor.onSelectedFileType.publishPage=!1,o.tab.pendingSave=!1})}else{var d=void 0;couiEditor.sceneSettings?d=couiEditor.sceneSettings:(console.warn(enums_1.default.warnMessages.sceneSettings),d={backgroundColor:"rgba(255, 255, 255, 0)",width:"1920",height:"1080",type:"aspectRatio16_9_full_hd"});var c=d.backgroundColor,_=d.width,p=d.height,g=d.type,E=function_helpers_1.default.getSceneSizeByType(g,_,p);couiEditor.createNewScene({style:{backgroundColor:c},sceneSize:E},i)}couiEditor.sceneSettings={}}}),engine.on("Ready",function(){couiEditor.init();var e=engine.call("prefs.get","preferences");if(null!==e.result)couiEditor.preferences=e.result,couiEditor.preferences.timeline?couiEditor.preferences.timeline.filterTimelineWidgets="true"===String(couiEditor.preferences.timeline.filterTimelineWidgets):couiEditor.preferences.timeline=editor_settings_1.default.defaultPreferences.timeline;else{couiEditor.preferences.couiEnvironment="GT";var i=editor_settings_1.default.defaultPreferences;engine.call("prefs.set","preferences",i),engine.call("prefs.save")}engine.call("RequestBackendInformation").then(function(e){vex.defaultOptions.className="vex-theme-flat-attack",localStorage.clear(),couiEditor.globalEditorInfo=e,Promise.all([System.import("lib/declarations"),System.import("lib/handlebars_helpers")]).then(function(i){couiEditor.EDITOR_VERSION=i[0].default.EDITOR_VERSION,couiEditor.Handlebars=i[1].default,couiEditor.attachEditorHandlers(),key_handlers_1.default.attachKeyHandlersGlobal(),e.backend!==enums_1.default.Backends.Debug&&e.backend!==enums_1.default.Backends.Website||couiEditor.attachBrowserHandlers();var t=editor_properties_1.default[editor_settings_1.default.environment[couiEditor.preferences.couiEnvironment]];couiEditor.environmentProperties=t;var n=t.DefaultExtensions;n="(."+(n=$.map(n,function(e){return[e].map(function(e){return e.join("|.")})}).join("|."))+")",couiEditor.listDirectory("",n,!0).then(function(e){couiEditor.updateSceneAssets(e)}),e.backend===enums_1.default.Backends.Unreal&&$(".btn-pref-file").parent().remove(),couiEditor.initSceneConfigVex(),engine.trigger("FrontendReady")})})}),engine.mock("RequestBackendInformation",function(){return"localhost"===document.location.hostname?{backend:enums_1.default.Backends.Debug}:{backend:enums_1.default.Backends.Website}}),engine.mock("LaunchURL",function(e){return window.open(e,"_blank")}),engine.mock("Save",function(e,i){engine.trigger("FileSaved",e,e)}),engine.mock("ListDirectory",function(e,i,t){return"widgets"!==e?[{__Type:"FileEntry",isFile:!0,url:"videos/big-buck-bunny.webm"},{__Type:"FileEntry",isFile:!0,url:"images/mobaSliced2_04.png"},{__Type:"FileEntry",isFile:!0,url:"mobaSliced2_03.png"},{__Type:"FileEntry",isFile:!0,url:"images/mobaSliced2_07.png"},{__Type:"FileEntry",isFile:!0,url:"testStyle.css"},{__Type:"FileEntry",isFile:!0,url:"css/testStyle.css"},{__Type:"FileEntry",isFile:!0,url:"css/style.css"},{__Type:"FileEntry",isFile:!0,url:"hello.js"},{__Type:"FileEntry",isFile:!1,url:"videos"},{__Type:"FileEntry",isFile:!1,url:"images"},{__Type:"FileEntry",isFile:!0,url:"images/ammo.png"},{__Type:"FileEntry",isFile:!0,url:"images/blueBar.png"},{__Type:"FileEntry",isFile:!0,url:"images/bulletsG.png"},{__Type:"FileEntry",isFile:!0,url:"images/bulletsW.png"},{__Type:"FileEntry",isFile:!0,url:"images/corner.png"},{__Type:"FileEntry",isFile:!0,url:"images/crosshair.png"},{__Type:"FileEntry",isFile:!0,url:"images/gun.png"},{__Type:"FileEntry",isFile:!0,url:"images/hb.png"},{__Type:"FileEntry",isFile:!0,url:"images/hbar.png"},{__Type:"FileEntry",isFile:!0,url:"images/health.png"},{__Type:"FileEntry",isFile:!0,url:"images/hTitles.png"},{__Type:"FileEntry",isFile:!0,url:"images/leftHover.png"},{__Type:"FileEntry",isFile:!0,url:"images/mask.png"},{__Type:"FileEntry",isFile:!0,url:"images/minimap.png"},{__Type:"FileEntry",isFile:!0,url:"images/minimapB.png"},{__Type:"FileEntry",isFile:!0,url:"images/minimapR.png"},{__Type:"FileEntry",isFile:!0,url:"images/redCorner.png"},{__Type:"FileEntry",isFile:!0,url:"images/rightHover.png"},{__Type:"FileEntry",isFile:!0,url:"images/target.png"},{__Type:"FileEntry",isFile:!0,url:"images/titles.png"},{__Type:"FileEntry",isFile:!0,url:"images/tittle1.png"},{__Type:"FileEntry",isFile:!0,url:"images/whiteHover.png"},{__Type:"FileEntry",isFile:!0,url:"fonts/Exo2-SemiBoldItalic.ttf"},{__Type:"FileEntry",isFile:!0,url:"fonts/ArimaMadurai-Black.ttf"}]:[{__Type:"FileEntry",isFile:!0,url:"widgets/minimap.html"},{__Type:"FileEntry",isFile:!1,url:"widgets"}]}),engine.trigger("Ready");