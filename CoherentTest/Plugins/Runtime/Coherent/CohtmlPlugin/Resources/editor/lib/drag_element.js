"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var function_helpers_1=require("./function_helpers"),main_1=require("../scripts/main"),transform_1=require("./transform"),DragElements;!function(t){function e(t,e,n){"string"==typeof t&&(t=document.getElementById(t)),null!==t&&t.addEventListener(e,n,!1)}function n(t,e,n){"string"==typeof t&&(t=document.getElementById(t)),null!==t&&t.removeEventListener(e,n,!1)}function o(t){return(t=t||window.event).stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault(),t.cancelBubble=!0,t.cancel=!0,t.returnValue=!1,!1}function a(){M=!1,F=!1;for(var t,e,n=[],o=0;o<m;o++){if(null!==V[o]&&(g[o].offsetTop,g[o].offsetLeft),t=(window.mouseCoordsX-f)/p,e=(window.mouseCoordsY-h)/p,null!==V[o]){var a=function_helpers_1.default.getElementAbsoluteTransformV2(b[o]),i=function_helpers_1.default.getTransformedCoordsGlobal(t,e,f,h,a);n.push(i)}else n.push(null)}for(var s=0;s<m;s++){for(var d=b[s].id,u=!0,c=!0;"scene"!==d&&-1!==x.indexOf(d);){var y=$("#"+d);u="auto"!==b[s].style.left&&""!==b[s].style.left,c="auto"!==b[s].style.top&&""!==b[s].style.top,d=y[0].parentElement.id}u&&!M&&null!==V[s]&&null!==n[s]&&(b[s].style.left=w[s]+n[s].x+"px"),c&&!F&&null!==V[s]&&null!==n[s]&&(b[s].style.top=v[s]+n[s].y+"px")}for(var E=0;E<m;E++){var D=g[E].attributes["data-widget-id"].nodeValue,C=main_1.default.selectedEditor,B=main_1.default.openFiles[C].runtimeEditor.mappedWidgets[D].widget;if(B.transformed_position){P.transform(B);var T=function_helpers_1.default.getTransformedElMaskPos(B);g[E].style.width=T.width+"px",g[E].style.height=T.height+"px",g[E].style.top=T.top+"px",g[E].style.left=T.left+"px"}}if(main_1.default.openFiles[main_1.default.selectedEditor].tab.snapOn&&0!==_.length){for(var W=r(b,!0)[0],L=0;L<_.length;L++){var I=_[L],O={dragValue:W.top,stationaryValue:I.top,styleValueDrag:"top",elementBounds:W,snapBox:I};l(O),O.stationaryValue=I.top+I.height,l(O),O.styleValueDrag="bottom",O.stationaryValue=I.top-W.height,l(O),O.stationaryValue=I.top+I.height-W.height,l(O),O.dragValue=W.left,O.stationaryValue=I.left,O.styleValueDrag="left",l(O),O.stationaryValue=I.left+I.width,l(O),O.styleValueDrag="right",O.stationaryValue=I.left-W.width,l(O),O.stationaryValue=I.left+I.width-W.width,l(O)}M||$("#snap-line-horizontal").css({display:"none"}),F||$("#snap-line-vertical").css({display:"none"})}}function l(t){var e=t.stationaryValue,n=t.dragValue,o=t.styleValueDrag;if(n>e-5&&n<e+5){if("left"===o||"right"===o){if(F)return}else if(M)return;s(t),i(t)}}function i(t){var e=t.styleValueDrag,n=t.snapBox,o=t.elementBounds,a=t.stationaryValue;if("top"===e||"bottom"===e){a="top"===e?a:a+o.height;var l=Math.min(n.left+n.width/2,o.left+o.width/2),i=Math.abs(l-Math.max(n.left+n.width/2,o.left+o.width/2));$("#snap-line-horizontal").css({display:"block",left:l+"px",top:a+"px",width:i+"px"}),M=!0}else{a="left"===e?a:a+o.width;var r=Math.min(n.top+n.height/2,o.top+o.height/2),s=Math.abs(r-Math.max(n.top+n.height/2,o.top+o.height/2));$("#snap-line-vertical").css({display:"block",left:a+"px",top:r+"px",height:s+"px"}),F=!0}}function r(t,e){for(var n=[],o=main_1.default.openFiles[main_1.default.selectedEditor].runtimeEditor,a=0;a<t.length;a++){var l=$("#"+t[a].id),i=l[0],r=$("#scene"),s=o.getWidgetBoundingRect(i),d=o.getWidgetBoundingRect(r[0]),u=function_helpers_1.default.rotationInfo(i);d.left=d.left+parseFloat(r.css("border-left-width")),d.top=d.top+parseFloat(r.css("border-top-width"));var p={width:s.right-s.left,height:s.bottom-s.top,left:s.left-d.left,top:s.top-d.top},f=getComputedStyle(i,null),h={left:parseFloat(f.getPropertyValue("border-left-width"))+parseFloat(f.getPropertyValue("margin-left")),right:parseFloat(f.getPropertyValue("border-right-width"))+parseFloat(f.getPropertyValue("margin-right")),top:parseFloat(f.getPropertyValue("border-top-width"))+parseFloat(f.getPropertyValue("margin-top")),bottom:parseFloat(f.getPropertyValue("border-bottom-width"))+parseFloat(f.getPropertyValue("margin-bottom"))},g=h.left+h.right,m=h.top+h.bottom,c=l.width()+g+parseFloat(f.getPropertyValue("padding-right"))+parseFloat(f.getPropertyValue("padding-left")),y=l.height()+m+parseFloat(f.getPropertyValue("padding-top"))+parseFloat(f.getPropertyValue("padding-bottom")),w=u.deg*Math.PI/180,v=Math.sin(w),x=Math.cos(w),b=x*c,V=v*c,_=-v*y,M=x*y,F=x*c-v*y,P=v*c+x*y,D=Math.min(0,b,_,F),C=Math.max(0,b,_,F),B=Math.min(0,V,M,P),T=Math.max(0,V,M,P);p.deltaWidth=(C-D-c)/2,p.deltaHeight=(T-B-y)/2,"scene"!==i.parentElement.id?p.isChild=!0:p.isChild=!1,n.push(p)}if(E=n,e&&E.length>1){for(var W={left:[],top:[],right:[],bottom:[],deltaWidth:[],deltaHeight:[]},L=0;L<n.length;L++)W.left.push(n[L].left),W.top.push(n[L].top),W.right.push(n[L].left+n[L].width),W.bottom.push(n[L].top+n[L].height),W.deltaWidth.push(n[L].deltaWidth),W.deltaHeight.push(n[L].deltaHeight);return W.left=Math.min.apply(Math,W.left),W.top=Math.min.apply(Math,W.top),W.width=Math.max.apply(Math,W.right)-W.left,W.height=Math.max.apply(Math,W.bottom)-W.top,W.deltaWidth=Math.max.apply(Math,W.deltaWidth),W.deltaHeight=Math.max.apply(Math,W.deltaHeight),delete W.right,delete W.bottom,[W]}return n}function s(t){var e,n,o=t.styleValueDrag,a=t.stationaryValue;"left"===o||"right"===o?(o="left",e="deltaWidth"):(o="top",e="deltaHeight");for(var l=t.elementBounds[o],i=0;i<b.length;i++)if(n=a+E[i][e]+E[i][o]-l,E[i].isChild&&-1===x.indexOf(b[i].parentElement.id)){var r=parseFloat(b[i].style.top),s=parseFloat(b[i].style.left),d=function_helpers_1.default.rotationInfo(b[i].parentElement,"single"),u=function_helpers_1.default.getAbsolutePosition(b[i],"scene"),p=function_helpers_1.default.getTransformedCoordsRotation(u.left,u.top,d.rad);u[o]=u[o]-(l-a);var f=function_helpers_1.default.getTransformedCoordsRotation(u.left,u.top,d.rad);b[i].style.top=r+f.y-p.y+"px",b[i].style.left=s+f.x-p.x+"px",g[i].style[o]=parseFloat(g[i].style[o])-(l-a)+"px"}else if(!E[i].isChild){var h=parseFloat(b[i].style[o]);b[i].style[o]=n+"px",g[i].style[o]=parseFloat(g[i].style[o])-(h-n)+"px"}}var d,u,p,f,h,g,m,c=[],y=[],w=[],v=[],x=[],b=[],V=[],_=[],E=[],M=!1,F=!1,P=new transform_1.default;t.dragObject=function(t,l,i,s,P,D,C,B,T){function W(t){var n=main_1.default.openFiles[main_1.default.selectedEditor],l=n.runtimeEditor.isInPanningMode;if(n.runtimeEditor.inputSearch.focusout(),!S&&z&&!R){if(!l){if(S=!0,null!==D&&D(),d=$("#scene")[0],u=new WebKitCSSMatrix(window.getComputedStyle(d).webkitTransform),p=u.a,f=window.mouseCoordsX,h=window.mouseCoordsY,g=document.getElementsByTagName("mask"),m=g.length,V=n.runtimeEditor.currentParentElementsSelection,x=n.runtimeEditor.currentElementsSelection,main_1.default.openFiles[main_1.default.selectedEditor].tab.snapOn){var i=n.runtimeEditor.mappedWidgets,s=$.map(i,function(t){if(-1===x.indexOf(t.widget.id))return t.widget}),E=x.map(function(t){if(i[t].widget.children.length>0)return i[t].widget.children.map(function(t){return t.id})});E=[].concat.apply([],E),s=s.filter(function(t){return-1===E.indexOf(t.id)}),_=r(s),$("<div/>",{id:"snap-line-horizontal"}).css({"background-color":"#d973d9","border-radius":"10px",position:"absolute",height:1/p+"px",display:"none"}).appendTo("#scene"),$("<div/>",{id:"snap-line-vertical"}).css({"background-color":"#d973d9","border-radius":"10px",position:"absolute",width:1/p+"px",display:"none"}).appendTo("#scene")}for(var M=0;M<m;M++)b[M]=document.getElementById(x[M]),c[M]=g[M].offsetTop,y[M]=g[M].offsetLeft,null!==V[M]&&(v[M]=b[M].offsetTop,w[M]=b[M].offsetLeft);return a(),e(document,"mousemove",L),e(document,"mouseup",I),o(t)}O()}}function L(t){if(!R&&!t.altKey)return a(),null!==C&&C(),o(event)}function I(t){return O(),o(t)}function O(){S&&!R&&($("#snap-line-horizontal").remove(),$("#snap-line-vertical").remove(),E=[],M=!1,F=!1,n(document,"mousemove",L),n(document,"mouseup",I),H=null,null!==B&&B(t),S=!1)}if(b=new Array(l),null!==s&&null!==P){var k=s.Min(P);P=s.Max(P),s=k}var H=null,S=!1,z=!1,R=!1;window.dispose=function(){R||(window.stopListening(!0),t=null,i=null,s=null,P=null,D=null,C=null,B=null,R=!0)},window.startListening=function(){z||R||(z=!0,e(i,"mousedown",W))},window.stopListening=function(t){z&&!R&&(n(i,"mousedown",W),z=!1,t&&S&&O())},window.isDragging=function(){return S},window.isListening=function(){return z},window.isDisposed=function(){return R},"string"==typeof i&&(i=document.getElementById(i)),null===i&&(i=t),T||window.startListening()}}(DragElements||(DragElements={})),exports.default=DragElements;