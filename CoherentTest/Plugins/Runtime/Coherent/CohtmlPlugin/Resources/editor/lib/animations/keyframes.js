"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var enums_1=require("../enums"),function_helpers_1=require("../function_helpers"),main_1=require("../../scripts/main"),timelineScrub_1=require("./timelineScrub"),Keyframes=function(){function e(e){this.currentKeyframeStack={},this.previousKeyframeStack={},this.runtimeEditor=e,this.templateKeyframeLine=document.getElementById("keyframe-line"),this.templateKeyframePropName=document.getElementById("keyframe-property-name"),this.templateKeyframe=document.getElementById("keyframe-html")}return e.prototype.init=function(){this.Timeline=this.runtimeEditor.Timeline,this.TimelineScrub=new timelineScrub_1.TimelineScrub(this.runtimeEditor)},e.prototype.widgetKeyframesHandlers=function(e){var t=this;$(e).find(".add-keyframe").off("click"),$(e).find(".add-keyframe").on("click",function(){t.runtimeEditor._sceneActionState.primaryAction="new action",t.collectKeyframeData($(this))})},e.prototype.onKeyframeChange=function(e,t,i){var a=e[0].attributes["data-keyframe-widget-id"].value,r=e[0].attributes["data-animation-class"].value,n=e[0].attributes["data-keyframe-property"].value,o=e[0].attributes["data-keyframe-group"].value,s=this.runtimeEditor.scene.animationClasses[r].keyframes[o][n],m=parseFloat(e[0].attributes["data-current-time"].value),d=function_helpers_1.default.getFromTimeline('[data-widget-id="'+a+'"] [data-property-type="'+n+'"][data-keyframe-group="'+o+'"]  [data-current-time="'+i+'"]');m!==i&&(s.renameProperty(t,i),s[i].time.seconds=i,d.length>0&&d.remove());var l=this.runtimeEditor.getRedoUndoPrimaryState();if("new action"!==l){var f=this.Timeline.convertTimeToOffsetX(i);e[0].style.left=f+"px",e[0].attributes["data-current-time"].value=i}var u={oldTime:t,currentTime:i};this.runtimeEditor._sceneActionState.moveKeyframe=!0,this.runtimeEditor.createUndoRedoCommand(l,a,o,o,n,u)},e.prototype.getValue=function(e,t,i){var a=e.parents(".wrap-property"),r=this.runtimeEditor.getSelectedWidgetId(),n=this.runtimeEditor.mappedWidgets[r].widget;switch(t){case"geometry":return this.runtimeEditor.getGeometryValue(a,t,i);case"transform-origin":return this.runtimeEditor.getTransformOriginValue(a,t,i);case"transform":return this.runtimeEditor.getTransformValue(a,t,i);case"-webkit-filter":return this.runtimeEditor.getFilterValues(n,t,i);case"boxShadow":return this.runtimeEditor.buildBoxShadowProperty(n);case"backgroundColor":return this.runtimeEditor.getBackgroundColorValue();case"styles":return this.runtimeEditor.getStyleValue(a,t,i);case"font":return this.runtimeEditor.getFontValue(a,t,i)}},e.prototype.collectKeyframeData=function(e){var t,i=this.runtimeEditor.getSelectedWidgetId(),a=this.Timeline.getPinTime(),r=e.attr("data-property-key"),n=e.attr("data-property-set");if("transform-origin"===r){var o=function_helpers_1.default.getFromTimeline('[data-property-set="transform-origin"][data-property-key="transform-origin-x"]'),s=function_helpers_1.default.getFromTimeline('[data-property-set="transform-origin"][data-property-key="transform-origin-y"]');t=this.getValue(o,n,"transform-origin-x")+" "+this.getValue(s,n,"transform-origin-y")}else if("perspective-origin"===r){var m=function_helpers_1.default.getFromTimeline('[data-property-set="styles"][data-property-key="perspective-origin-x"]'),d=function_helpers_1.default.getFromTimeline('[data-property-set="styles"][data-property-key="perspective-origin-y"]');t=this.getValue(m,n,"perspective-origin-x")+" "+this.getValue(d,n,"perspective-origin-y")}else t=this.getValue(e,n,r);"-webkit-filter"===n&&(r=enums_1.default.StylePropToKeyframeProp[n][r]),function_helpers_1.default.notAllowedForAnimation(r,t)||(this.runtimeEditor.Animations.addKeyframe(i,n,r,t,a),"transform"===n&&function_helpers_1.default.syncTransformAnimations(i,r),"-webkit-filter"===n&&function_helpers_1.default.syncFiltersAnimations(i,r))},e.prototype.addKeyframe=function(e,t,i,a,r){var n=this.runtimeEditor,o=n.mappedWidgets[e].widget,s=n.mappedWidgets[e].widget.className||"";""!==s&&(s=function_helpers_1.default.getAnimationClassNames(s));var m=function_helpers_1.default.getFromTimeline('[data-keyframe-widget-id="'+e+'"][data-keyframe-property="'+i+'"][data-keyframe-group="'+t+'"][data-current-time="'+r.seconds+'"]');if(1===m.length){var d=this.Timeline.getKeyframeWidgetData(m);if(d.className===s&&d.prop===i&&d.value===a)return}if(n._sceneActionState.keyframeInitial)this.setKeyframe(e,t,i,a,r,s);else{var l=function_helpers_1.default.getFromTimeline('[data-timeline-info-widget-id="'+e+'"] .info-property-name'),f={positions:$.extend(!0,{},r),value:a},u=n.getRedoUndoPrimaryState();if(m.length>0&&(f.oldKeyframe=n.scene.animations[e][s].keyframes[t][i][r.seconds]),0===l.length&&"new action"===u){var p=!1;""===s&&(main_1.default.preferences.timeline.filterTimelineWidgets&&n.Timeline.addWidget(o,{initial:!1}),s=main_1.default.generateClassName(),p=!0),f.className=s;var c=$(this).parents(".info-class-name").find(".animation-class-name-input").val()||"";n._sceneActionState.switchAnimationClass=!0,this.Timeline.initAnimationClassName(e,c,s),this.setKeyframe(e,t,i,a,r,s);var y=0,g=[];for(var h in n.scene.animations)h!==e&&n.scene.animations[h].className===s&&(y++,this.setKeyframe(h,t,i,a,r,s),g.push(h));for(var _=0;_<y;_++)n._sceneActionState.addKeyframe=!0,n.createUndoRedoCommand(u,g[_],t,t,i,f);p&&n.autoKeyframe&&"new action"===n._sceneActionState.primaryAction&&(n._sceneActionState.addKeyframe=!0,n._undoCreationStepsLength+=1,n.createUndoRedoCommand(u,e,t,t,i,f))}else if("new action"!==u){0===l.length&&(n.Animations.createAnimationWidget(o,{initial:!1}),this.Timeline.initAnimationClassName(e,"",s,!1,!0),function_helpers_1.default.getFromTimeline('[data-timeline-info-widget-id="'+e+'"] .animation-class-name-input').show()),this.setKeyframe(e,t,i,a,r,s);for(var h in n.scene.animations)h!==e&&n.scene.animations[h].className===s&&this.setKeyframe(h,t,i,a,r,s);f.className=s,n._sceneActionState.addKeyframe=!0,n.createUndoRedoCommand(u,e,t,t,i,f)}else{var y=0,g=[];for(var h in n.scene.animations)n.scene.animations[h][s]&&(y++,n.autoKeyframe||n.forceAutoKeyframes||(n._undoCreationStepsLength=y),this.setKeyframe(h,t,i,a,r,s),g.push(h));f.className=s;for(var v=0;v<y;v++)n._sceneActionState.addKeyframe=!0,n.createUndoRedoCommand(u,g[v],t,t,i,f)}}function_helpers_1.default.getFromTimeline(".info-widgets").getNiceScroll().resize()},e.prototype.buildKeyframeObject=function(e,t,i,a,r){var n=this.runtimeEditor.mappedWidgets[e].widget.className.split(" "),o=this.runtimeEditor.scene.animations,s=this.runtimeEditor.scene.animationClasses;return n.filter(function(n){s[n]&&(s[n]=s[n]||$.extend(!0,{},enums_1.default.newAnimation),s[n].className=n,s[n].keyframes[t]=s[n].keyframes[t]||{},s[n].animationsData[t]=s[n].animationsData[t]||{},s[n].animationsData[t][i]=s[n].animationsData[t][i]||{timing:"linear",direction:"normal",iteration:1,name:n+"_"+t+"_"+i},s[n].keyframes[t][i]=s[n].keyframes[t][i]||{},s[n].keyframes[t][i][r.seconds]={property:i,group:t,values:[a],time:r},o[e]=o[e]||{},o[e][n]||(o[e][n]=s[n]),o[e].id=e,o[e].className=n)}),o},e.prototype.setKeyframe=function(e,t,i,a,r,n){var o=this.buildKeyframeObject(e,t,i,a,r),s=function_helpers_1.default.getFromTimeline('[data-keyframe-widget-id="'+e+'"][data-keyframe-property="'+i+'"][data-keyframe-group="'+t+'"][data-current-time="'+r.seconds+'"]');s.length>0&&s.remove();var m=main_1.default.importHtmlTemplate(this.templateKeyframeLine);if(m.setAttribute("data-property-type",i),function_helpers_1.default.getFromTimeline('[data-widget-id="'+e+'"] [data-property-type="'+i+'"]').length<=0){var d=function_helpers_1.default.getFromTimeline('[data-timeline-info-widget-id="'+e+'"]'),l=main_1.default.importHtmlTemplate(this.templateKeyframePropName);l.setAttribute("data-timeline-info-property-name",i),$(l).addClass(n),$(l).find(".property-name-text").text(i);var f=l.querySelectorAll(".ic-properties");d.append(l),function_helpers_1.default.getFromTimeline('.widgets-keyframes [data-widget-id="'+e+'"]').append(m),this.Timeline.createTooltip(function_helpers_1.default.getFromTimeline(f),o[e],t,i)}var u=main_1.default.importHtmlTemplate(this.templateKeyframe);u.classList.add("keyframe","dragging-point"),u.setAttribute("data-current-time",r.seconds),u.setAttribute("data-keyframe-group",t),u.setAttribute("data-keyframe-property",i),u.setAttribute("data-keyframe-widget-id",e),u.setAttribute("data-animation-class",n);var p=this.Timeline.convertTimeToOffsetX(r.seconds);u.style.left=p+"px";var c=function_helpers_1.default.getFromTimeline('[data-widget-id="'+e+'"] [data-property-type="'+i+'"]');c.append(u),c.addClass(n),u.offsetLeft>$("#timeline-ruler").width()&&(this.Timeline.originalRulerWidth=u.offsetLeft+200)},e}();exports.default=Keyframes;