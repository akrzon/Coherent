"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var function_helpers_1=require("../function_helpers"),units_conversion_1=require("scripts/helpers/units_conversion"),enums_1=require("../enums"),main_1=require("../../scripts/main"),TimelineScrub=function(){function e(e){this.currentKeyframeStack={},this.previousKeyframeStack={},this.runtimeEditor=e}return e.prototype.returnKeyframeValues=function(e){var t=$.extend(!0,{},e),r=parseFloat(Object.keys(t)[0]);return"number"!=typeof r||isNaN(r)?(t=t[Object.keys(t)[0]],this.returnKeyframeValues(t)):t},e.prototype.findKeyFramesBetweenTime=function(e,t,r){var i,o=[];for(i in r)((i=parseFloat(i))>=e&&i<=t||i<=e&&i>=t)&&i!==e&&o.push(i);return t<e&&o.reverse(),o},e.prototype.renderKeyframesInTime=function(e,t){if(e!==t){var r=[],i="";if(!this.runtimeEditor.iframe){var o=this.runtimeEditor.scene.animations;for(var a in o){var n=o[a].id;for(var s in o[a])for(var l in o[a][s].keyframes){i=l;for(var u in o[a][s].keyframes[l])r=r.concat(this.findKeyFramesBetweenTime(e,t,o[a][s].keyframes[l][u]))}r.push(t),r=function_helpers_1.default.removeDuplicates(r),e>t?r.sort(function(e,t){return t-e}):r.sort(function(e,t){return e-t});for(var p=0;p<r.length;p++)this.currentKeyframeStack[n]={},this.performTimelineScrub(n,r[p]),this.executeStackedStyleChanges(i)}}}},e.prototype.executeStackedStyleChanges=function(e){for(var t in this.currentKeyframeStack){var r=document.getElementById(t);for(var i in this.currentKeyframeStack[t])r.style[i]=this.currentKeyframeStack[t][i]}this.previousKeyframeStack=$.extend(!0,{},this.currentKeyframeStack),this.currentKeyframeStack={}},e.prototype.updateStackedStyleChanges=function(e,t){var r="rotate"===e.styleType?"transform":e.styleType;void 0!==this.previousKeyframeStack[e.id]&&this.previousKeyframeStack[e.id][r]===e.newValue||(void 0===this.currentKeyframeStack[e.id]&&(this.currentKeyframeStack[e.id]={}),this.currentKeyframeStack[e.id][r]||(this.currentKeyframeStack[e.id][r]=""),"-webkit-filter"===e.propGroup?"dropShadowBlur"!==t&&"dropShadowX"!==t&&"dropShadowY"!==t&&"dropShadowColor"!==t&&(this.currentKeyframeStack[e.id][r]+=t+"("+e.newValue.trim()+")"):this.currentKeyframeStack[e.id][r]=e.newValue)},e.prototype.adjustBackgroundSize=function(e,t,r,i){var o,a,n=e.split(" "),s=t.split(" "),l=parseFloat(units_conversion_1.default.convertUnitsToPixel(i,n[0],"backgroundSize")),u=parseFloat(units_conversion_1.default.convertUnitsToPixel(i,n[1],"backgroundSize")),p=l+(parseFloat(units_conversion_1.default.convertUnitsToPixel(i,s[0],"backgroundSize"))-l)/100*r,d=u+(parseFloat(units_conversion_1.default.convertUnitsToPixel(i,s[1],"backgroundSize"))-u)/100*r;return r<50?(o=function_helpers_1.default.getUnitStyle(n[0]),a=function_helpers_1.default.getUnitStyle(n[1])):(o=function_helpers_1.default.getUnitStyle(s[0]),a=function_helpers_1.default.getUnitStyle(s[1])),{appliedValue:p+"px "+d+"px",displayedValue:units_conversion_1.default.convertPixelToUnit(i,p,o,"backgroundSize")+" "+units_conversion_1.default.convertPixelToUnit(i,d,a,"backgroundSize")}},e.prototype.adjustBoxShadowInset=function(e,t,r,i){var o=e.split(" "),a=t.split(" "),n=r.split(" ");return n[0]=i<50?"remove"!==o[0]?o[0]:a[0]:"remove"!==a[0]?a[0]:o[0],n.join(" ").replace("remove","").trim()},e.prototype.modulateStyleValue=function(e,t,r,i,o){for(var a=[],n=0;n<t.length;n++){var s=parseFloat(t[n]),l=parseFloat(r[n]);a[n]=s+(l-s)/100*i}var u=0;return e.map(function(e){if(isNaN(parseInt(e))&&0!==e.indexOf("#"))return e;switch(o){case"backgroundSize":case"-webkit-mask-size":case"boxShadowProperties":case"filterProperties":case"borderColor":case"backgroundColor":return a[u++].toFixed(2);case"transform":case"transform-origin":case"perspective-origin":return a[u++].toFixed(1);case"color":return 3===u?a[u++].toFixed(2):a[u++].toFixed(0);case"-webkit-mask-position-x":case"-webkit-mask-position-y":case"borderWidth":case"borderTopLeftRadius":case"borderTopRightRadius":case"borderBottomLeftRadius":case"borderBottomRightRadius":case"backgroundPositionX":case"backgroundPositionY":case"opacity":case"left":case"top":case"width":case"height":case"scaleX":case"scaleY":case"scaleZ":return a[0].toFixed(2);case"rotate":case"fontSize":case"rotateX":case"rotateY":case"rotateZ":case"translateX":case"translateY":case"translateZ":case"skewX":case"skewY":case"perspective":return a[0].toFixed(1);case"zIndex":return a[0].toFixed(0)}}).join("")},e.prototype.adjustForStringStylesValues=function(e){var t=/([-|+|#]?\d*\.?\d+)/g,r=e.percentageShift>50,i=e.lowerKeyframeValue.match(t),o=e.higherKeyframeValue.match(t);if(null===i||null===o||"fontWeight"===e.styleType||"fontStyle"===e.styleType)e.newValue=r?e.higherKeyframeValue:e.lowerKeyframeValue,e.originalValue=e.newValue;else if("-webkit-filter"===e.propGroup){var a=e.lowerKeyframeValue.match(/\((.*?)\)/);null!==a&&(e.originalValue=a[1]);n=e.lowerKeyframeValue.split(t);e.newValue=this.modulateStyleValue(n,i,o,e.percentageShift,e.styleType)}else{var n=e.lowerKeyframeValue.split(t);e.newValue=this.modulateStyleValue(n,i,o,e.percentageShift,e.styleType),""!==e.lowerKeyframeStyle.trim()&&""!==e.higherKeyframeStyle.trim()&&"transform"!==e.propGroup&&"transform-origin"!==e.propGroup&&"perspective-origin"!==e.styleType?r&&!function_helpers_1.default.isBackgroundPositionString(e.originalValue)?e.originalValue=units_conversion_1.default.convertPixelToUnit(e.id,e.newValue,e.higherKeyframeStyle,e.styleType):function_helpers_1.default.isBackgroundPositionString(e.originalValue)||(e.originalValue=units_conversion_1.default.convertPixelToUnit(e.id,e.newValue,e.lowerKeyframeStyle,e.styleType)):e.originalValue=e.newValue}return e},e.prototype.adjustForBackgroundPosition=function(e){var t=e.percentageShift>50;return"backgroundPositionX"!==e.styleType&&"backgroundPositionY"!==e.styleType&&"-webkit-mask-position-y"!==e.styleType&&"-webkit-mask-position-x"!==e.styleType||(e.originalValue=t?e.higherKeyframeValue:e.lowerKeyframeValue,"center"===e.lowerKeyframeValue||"bottom"===e.lowerKeyframeValue||"right"===e.lowerKeyframeValue?e.lowerKeyframeValue=this.runtimeEditor._fixBackgroundPercentage(e.lowerKeyframeValue,e.id,e.styleType):e.lowerKeyframeValue=function_helpers_1.default.getStringPropertyPercent(e.lowerKeyframeValue),"center"===e.higherKeyframeValue||"bottom"===e.higherKeyframeValue||"right"===e.higherKeyframeValue?e.higherKeyframeValue=this.runtimeEditor._fixBackgroundPercentage(e.higherKeyframeValue,e.id,e.styleType):e.higherKeyframeValue=function_helpers_1.default.getStringPropertyPercent(e.higherKeyframeValue)),e},e.prototype.adjustGroupedStyles=function(e,t){var r=!1;if(1===this.runtimeEditor.currentElementsSelection.length&&this.runtimeEditor.currentElementsSelection[0]===e.id&&(r=!0),r&&"transform-origin"!==e.styleType&&"perspective-origin"!==e.styleType&&!function_helpers_1.default.isTransformProperty(e.styleType)&&"-webkit-mask-size"!==e.styleType&&"filterProperties"!==e.styleType){var i=function_helpers_1.default.shortenLongValue(e.originalValue);this.runtimeEditor.setPropertiesBarValue(e.id,e.propGroup,e.styleType,i)}if("left"===e.styleType||"top"===e.styleType||"width"===e.styleType||"height"===e.styleType||"fontSize"===e.styleType){var o=function_helpers_1.default.getUnitStyle(e.newValue);"px"!==o&&"%"!==o&&(e.newValue=units_conversion_1.default.convertUnitsToPixel(e.id,e.newValue))}else if("filterProperties"===e.styleType)e.styleType="-webkit-filter",r&&this.runtimeEditor.setFilterInput(e.styleType,t,e.newValue);else if("boxShadowProperties"===e.styleType){if(e.styleType="boxShadow",e.newValue=this.adjustBoxShadowInset(e.lowerKeyframeValue,e.higherKeyframeValue,e.newValue,e.percentageShift),r)for(var a=function_helpers_1.default.getValuesBoxshadow(e.newValue),n=0;n<a.length-1;n+=2)this.runtimeEditor.setBoxShadowInput(e.styleType,a[n],a[n+1])}else if("rotate"===e.styleType)e.originalValue=e.newValue,e.newValue="rotate("+e.newValue+")";else if("backgroundSize"===e.styleType){var s=this.adjustBackgroundSize(e.lowerKeyframeValue,e.higherKeyframeValue,e.percentageShift,e.id);e.newValue=s.appliedValue,r&&this.runtimeEditor.selectKendoDropdownItem("styles","backgroundSize",s.displayedValue)}else if("-webkit-mask-size"===e.styleType){var l=e.newValue.split(" ");l.length>1?(this.runtimeEditor.setPropertiesBarValue(e.id,e.propGroup,"-webkit-mask-sizeWidth",l[0]),this.runtimeEditor.setPropertiesBarValue(e.id,e.propGroup,"-webkit-mask-sizeHeight",l[1])):this.runtimeEditor.selectKendoDropdownItem("styles",e.styleType,e.newValue)}else(function_helpers_1.default.isTransformProperty(e.styleType)||"transform-origin"===e.styleType||"perspective-origin"===e.styleType)&&(e=this.adjustTransformStyles(e));return e},e.prototype.adjustTransformStyles=function(e){e.originalValue="edited_transform";var t,r,i={};function_helpers_1.default.isTransformProperty(e.styleType)?(t=[e.styleType],i[e.styleType]=[e.newValue]):"perspective-origin"===e.styleType?(t=["perspective-origin-x","perspective-origin-y"],i={"perspective-origin-x":(r=e.newValue.split(" "))[0],"perspective-origin-y":r[1]}):(t=["transform-origin-x","transform-origin-y"],i={"transform-origin-x":(r=e.newValue.split(" "))[0],"transform-origin-y":r[1]});for(var o=0;o<t.length;o++){var a=t[o],n=i[a],s=this.runtimeEditor.mappedWidgets[e.id].widget;"transform-origin"===e.propGroup?this.runtimeEditor._setTransformOrigin(null,s,s.id,e.propGroup,a,n[0]):"perspective-origin"===e.styleType?this.runtimeEditor._setStyles(null,s,s.id,e.propGroup,a,n[0]):this.runtimeEditor._setTransform(null,s,s.id,e.propGroup,e.styleType,n[0])}return e},e.prototype.adjustForUnitConversion=function(e){var t=["pt","rem","vh","vw","vmax","vmin","%"];return-1!==t.indexOf(e.lowerKeyframeStyle)&&"backgroundSize"!==e.styleType&&"-webkit-mask-size"!==e.styleType&&"transform-origin"!==e.styleType&&"perspective-origin"!==e.styleType&&(e.lowerKeyframeValue=units_conversion_1.default.convertUnitsToPixel(e.id,e.lowerKeyframeValue,e.styleType)),-1!==t.indexOf(e.higherKeyframeStyle)&&"backgroundSize"!==e.styleType&&"-webkit-mask-size"!==e.styleType&&"transform-origin"!==e.styleType&&"perspective-origin"!==e.styleType&&(e.higherKeyframeValue=units_conversion_1.default.convertUnitsToPixel(e.id,e.higherKeyframeValue,e.styleType)),e},e.prototype.adjustForFilterValues=function(e,t,r){return e.lowerKeyframeValue=function_helpers_1.default.buildFilterProps(t[r.lower],!1),e.higherKeyframeValue=function_helpers_1.default.buildFilterProps(t[r.higher],!1),e},e.prototype.performTimelineScrub=function(e,t,r,i,o){void 0===i&&(i=!1);var a,n=[];if(r)a=this.runtimeEditor.scene.animationClasses[r];else{var s=this.runtimeEditor.scene.animations[e];if(!s)return;if(!(a=this.runtimeEditor.scene.animations[e][s.className]))return}var l=a.keyframes,u=Object.keys(l);null===e&&(u=[o]);for(var p=0;p<u.length;p++){var d=l[u[p]],y=Object.keys(d).length,f=!1,c=void 0,h={id:e,styleType:"",newValue:"",propGroup:"",originalValue:"",lowerKeyframeValue:"",lowerKeyframeStyle:"",higherKeyframeValue:"",higherKeyframeStyle:"",percentageShift:0};(d.dropShadowX||d.dropShadowY||d.dropShadowColor||d.dropShadowBlur)&&(f=!0);for(var m=0;m<y;m++){var g={};g[Object.keys(d)[m]]=d[Object.keys(d)[m]];var w=this.returnKeyframeValues(g),S=Object.keys(w).map(function(e){return parseFloat(e)}),V=void 0,v=void 0;if(-1!==S.indexOf(t)?V=v=t:(V=function_helpers_1.default.biggerClosest(S,t),v=function_helpers_1.default.smallerClosest(S,t)),i||v<=t&&V>=t||"-webkit-filter"===w[v].group){h.percentageShift=(t-v)/(V-v)*100,h.percentageShift=isFinite(h.percentageShift)?h.percentageShift:100,h.propGroup=w[v].group,h.styleType=w[v].property,c=h.styleType,h.lowerKeyframeValue=w[v].values[0],h.higherKeyframeValue=w[V].values[0];var _=enums_1.default["-webkit-filterDefaultValues"][h.styleType];"-webkit-filter"===h.propGroup&&"undefined"!==_&&(h.styleType="filterProperties",h=this.adjustForFilterValues(h,w,{lower:v,higher:V})),h.lowerKeyframeValue=function_helpers_1.default.convertColorValues(h.lowerKeyframeValue),h.higherKeyframeValue=function_helpers_1.default.convertColorValues(h.higherKeyframeValue),(h=this.adjustForBackgroundPosition(h)).lowerKeyframeStyle=function_helpers_1.default.getUnitStyle(h.lowerKeyframeValue),h.higherKeyframeStyle=function_helpers_1.default.getUnitStyle(h.higherKeyframeValue),h=this.adjustForUnitConversion(h),(h=this.adjustForStringStylesValues(h)).newValue=function_helpers_1.default.stylesValueNormalizer(h.newValue),h.originalValue=function_helpers_1.default.stylesValueNormalizer(h.originalValue),"-webkit-filter"===h.propGroup&&function_helpers_1.default.buildDropShadowFiltersProps(w[v],h.newValue),null!==e&&(h=this.adjustGroupedStyles(h,c)),"edited_transform"!==h.originalValue&&null!==e&&this.updateStackedStyleChanges(h,w[V].property),i?("dropShadowX"!==c&&"dropShadowY"!==c&&"dropShadowColor"!==c&&"dropShadowBlur"!==c&&n.push({key:c,value:h.newValue}),m+1===y&&f&&(n.push({key:"dropShadow",value:function_helpers_1.default.buildDropShadowProperty(this.runtimeEditor.runtimeBuildDropShodowFilter)}),this.runtimeEditor.runtimeBuildDropShodowFilter=function_helpers_1.default.getBoxShodowDefaults())):this.applyStyleToWidget(h,c)}}if("-webkit-filter"===h.styleType&&!i&&f){var k=main_1.default.openFiles[main_1.default.selectedEditor].runtimeEditor,T=function_helpers_1.default.buildDropShadowProperty(k.runtimeBuildDropShodowFilter);this.currentKeyframeStack[e][h.styleType]+=T,this.runtimeEditor.runtimeBuildDropShodowFilter=function_helpers_1.default.getBoxShodowDefaults()}}if(i)return n},e.prototype.applyStyleToWidget=function(e,t){var r=this;if(null!==e.id){var i=function_helpers_1.default.shortenLongValue(e.originalValue);if("backgroundColor"===e.propGroup)this.runtimeEditor.mappedWidgets[e.id].widget.background=i;else if("-webkit-mask-size"===e.styleType){var o=e.newValue.split(" ");o.length>1?(this.runtimeEditor.mappedWidgets[e.id].widget[e.propGroup]["-webkit-mask-size"]="auto",this.runtimeEditor.mappedWidgets[e.id].widget[e.propGroup]["-webkit-mask-sizeWidth"]=o[0],this.runtimeEditor.mappedWidgets[e.id].widget[e.propGroup]["-webkit-mask-sizeHeight"]=o[1]):this.runtimeEditor.mappedWidgets[e.id].widget[e.propGroup][e.styleType]=i}else if("fontSize"===e.styleType)this.runtimeEditor.mappedWidgets[e.id].widget.fontSize=i;else if("color"===e.styleType)this.runtimeEditor.mappedWidgets[e.id].widget.color=i;else if("transform-origin"===e.styleType){var a=e.newValue.split(" ");this.runtimeEditor.mappedWidgets[e.id].widget["transform-origin"]["transform-origin-x"]=a[0],this.runtimeEditor.mappedWidgets[e.id].widget["transform-origin"]["transform-origin-y"]=a[1]}else if("perspective-origin"===e.styleType){var n=e.newValue.split(" ");this.runtimeEditor.mappedWidgets[e.id].widget["perspective-origin"]["perspective-origin-x"]=n[0],this.runtimeEditor.mappedWidgets[e.id].widget["perspective-origin"]["perspective-origin-y"]=n[1]}else if(function_helpers_1.default.isTransformProperty(e.styleType))this.runtimeEditor.mappedWidgets[e.id].widget.transform[e.styleType]=e.newValue;else if("-webkit-filter"===e.styleType){var s=function_helpers_1.default.getWebkitFilterObject(e.newValue);0!==Object.keys(s).length?Object.keys(s).map(function(t){r.runtimeEditor.mappedWidgets[e.id].widget[e.propGroup][t]=s[t]}):this.runtimeEditor.mappedWidgets[e.id].widget[e.propGroup][t]=e.newValue}else if("boxShadow"===e.styleType){var l=function_helpers_1.default.getBoxshadowObject(e.newValue);Object.keys(l).map(function(t){r.runtimeEditor.mappedWidgets[e.id].widget[e.propGroup][t]=l[t]})}else this.runtimeEditor.mappedWidgets[e.id].widget[e.propGroup][e.styleType]=i}},e}();exports.TimelineScrub=TimelineScrub;