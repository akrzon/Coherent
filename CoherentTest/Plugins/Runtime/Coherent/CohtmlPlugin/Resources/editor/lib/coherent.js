!function(e){"use strict";"object"==typeof module&&module.exports?module.exports=e(global,global.engine,!1):window.engine=e(window,window.engine,!0)}(function(e,t,n){"use strict";function r(){this.events={}}function o(e,t){this.code=e,this.context=t}function i(e,t,n){setTimeout(function(){e.call(t,n)})}function a(){this.emitter=new r,this.state=h,this.result=null}function s(e){return function(){return e}}function c(e){return function(){var n=Array.prototype.slice.call(arguments);return n.splice(0,0,e,this._id),t.call.apply(t,n)}}var l=[1,7,3,1];r.prototype._createClear=function(e,n,r){return function(){var o=e.events[n];if(o){var i=-1;if(void 0===r){for(var a=0;a<o.length;++a)if(void 0!==o[a].wasInCPP){i=a;break}}else i=o.indexOf(r);-1!==i&&(o.splice(i,1),0===o.length&&delete e.events[n])}else void 0!==t.RemoveOnHandler&&t.RemoveOnHandler(n)}},r.prototype.on=function(e,t,n){var r=this.events[e];void 0===r&&(r=this.events[e]=[]);var i=new o(t,n||this);return r.push(i),{clear:this._createClear(this,e,i)}},r.prototype.off=function(e,n,r){var o=this.events[e];if(void 0!==o){r=r||this;var i,a=o.length;for(i=0;i<a;++i){var s=o[i];if(s.code===n&&s.context===r)break}i<a&&(o.splice(i,1),0===o.length&&delete this.events[e])}else t.RemoveOnHandler(e)};var d=void 0!==t;(t=t||{}).isAttached=d,t.IsAttached=t.isAttached,t.onEventsReplayed=null,r.prototype.trigger=function(e){var t=this.events[e];if(void 0!==t){var n=Array.prototype.slice.call(arguments,1);t.forEach(function(e){e.code.apply(e.context,n)})}},r.prototype.merge=function(e){var t,n=this.events,r=e.events,o=Array.prototype.push;for(var i in r)t=n[i]=n[i]||[],o.apply(t,r[i])};var h="pending";a.prototype.resolve=function(e){this.state="fulfilled",this.result=e,this.emitter.trigger("fulfilled",e)},a.prototype.reject=function(e){this.state="broken",this.result=e,this.emitter.trigger("broken",e)},a.prototype.success=function(e,t){return"fulfilled"!==this.state?this.emitter.on("fulfilled",e,t):i(e,t||this,this.result),this},a.prototype.always=function(e,t){return this.success(e,t),this.otherwise(e,t),this},a.prototype.otherwise=function(e,t){return"broken"!==this.state?this.emitter.on("broken",e,t):i(e,t||this,this.result),this},a.prototype.merge=function(e){if(this.state===h)this.emitter.merge(e.emitter);else{var t=e.emitter.events[this.state],n=this;void 0!==t&&t.forEach(function(e){e.code.call(e.context,n.result)})}},a.prototype.makeChain=function(e,t,n){return function(r){var o;try{(o=e.code.call(e.context,r))instanceof a?o.merge(t):this.state===n?t.resolve(o):t.reject(o)}catch(e){t.reject(e)}}},a.prototype.then=function(e,t){var n=new a,r=new o(e||s(this),this);this.success(this.makeChain(r,n,"fulfilled"),this);var i=new o(t||s(this),this);return this.otherwise(this.makeChain(i,n,"broken"),this),n},t.isAttached||(r.prototype.on=function(e,t,n){var r=this.events[e];this.browserCallbackOn&&this.browserCallbackOn(e,t,n),void 0===r&&(r=this.events[e]=[]);var i=new o(t,n||this);return r.push(i),{clear:this._createClear(this,e,i)}},r.prototype.off=function(e,t,n){var r=this.events[e];if(void 0!==r){n=n||this;var o,i=r.length;for(o=0;o<i;++o){var a=r[o];if(a.code===t&&a.context===n)break}o<i&&(r.splice(o,1),0===r.length&&(delete this.events[e],this.browserCallbackOff&&this.browserCallbackOff(e,t,n)))}},t.SendMessage=function(e,n){var r=Array.prototype.slice.call(arguments,2),o=t._ActiveRequests[n];delete t._ActiveRequests[n];window.setTimeout(function(){var n=t._mocks[e];void 0!==n&&o.resolve(n.apply(t,r))},16)},t.TriggerEvent=function(){var e=Array.prototype.slice.call(arguments);window.setTimeout(function(){var n=t._mocks[e[0]];void 0!==n&&n.apply(t,e.slice(1))},16)},t.BindingsReady=function(){t._OnReady()},t.__observeLifetime=function(){},t.beginEventRecording=t.endEventRecording=t.saveEventRecord=function(){console.warning("Event recording will not work in the browser!")},t._mocks={},t._mockImpl=function(e,t,n,r){t&&(this._mocks[e]=t);var o=t.toString().replace("function "+t.name+"(",""),i=o.indexOf(")"),a=o.substr(0,i);this.browserCallbackMock&&this.browserCallbackMock(e,a,n,Boolean(r))},t.mock=function(e,t,n){this._mockImpl(e,t,!0,n)},t.translate=function(e){return e}),t.events={};for(var u in r.prototype)t[u]=r.prototype[u];t.isAttached&&(t.on=function(e,n,r){var i=this.events[e];if(void 0===i&&void 0!==t.AddOrRemoveOnHandler){var a=t.AddOrRemoveOnHandler(e,n,r);if(void 0===a)return{clear:this._createClear(this,e,void 0)};i=this.events[e]=[];var s=new o(a[0],a[1]||this);s.wasInCPP=!0,i.push(s)}else void 0===i&&(i=this.events[e]=[]);var c=new o(n,r||this);return i.push(c),{clear:this._createClear(this,e,c)}}),t._trigger=r.prototype.trigger;var v=Array.prototype.concat;return t.trigger=function(e){if(this._trigger.apply(this,arguments),this.TriggerEvent.apply(this,arguments),void 0!==this.events.all){var t=v.apply(["all"],arguments);this._trigger.apply(this,t)}},t.showOverlay=function(){},t.hideOverlay=function(){},t.isAttached&&(t.mock=function(e,t,n){}),t._BindingsReady=!1,t._WindowLoaded=!1,t._RequestId=0,t._ActiveRequests={},t.createDeferred=void 0===e.engineCreateDeferred?function(){return new a}:e.engineCreateDeferred,t.call=function(){t._RequestId++;var e=t._RequestId,n=t.createDeferred();t._ActiveRequests[e]=n;var r=Array.prototype.slice.call(arguments);return r.splice(1,0,e),t.SendMessage.apply(this,r),n},t._Result=function(e){var n=t._ActiveRequests[e];if(void 0!==n){delete t._ActiveRequests[e];var r=Array.prototype.slice.call(arguments);r.shift(),n.resolve.apply(n,r)}},t._Errors=["Success","ArgumentType","NoSuchMethod","NoResult"],t._ForEachError=function(e,t){for(var n=e.length,r=0;r<n;++r)t(e[r].first,e[r].second)},t._MapErrors=function(e){for(var n=e.length,r=0;r<n;++r)e[r].first=t._Errors[e[r].first]},t._TriggerError=function(e,n){t.trigger("Error",e,n)},t._OnError=function(e,n){if(t._MapErrors(n),null===e||0===e)t._ForEachError(n,t._TriggerError);else{var r=t._ActiveRequests[e];delete t._ActiveRequests[e],r.reject(n)}},t._eventHandles={},t._Register=function(e){var n=function(e,t){return function(){var n=[e];n.push.apply(n,arguments),t.TriggerEvent.apply(this,n)}}(e,t);t._eventHandles[e]=t.on(e,n)},t._removeEventThunk=function(e){t._eventHandles[e].clear(),delete t._eventHandles[e]},t._Unregister=function(e){"string"==typeof e?t._removeEventThunk(e):e.forEach(t._removeEventThunk,t)},t._boundTypes={},t._createInstance=function(e){var n=e[0],r=e[1],o=e[2],i=t._boundTypes[n];void 0===i&&((i=function(e){this._id=e}).prototype.__Type=n,o.forEach(function(e){i.prototype[e]=c(n+"_"+e)}),t._boundTypes[n]=i);var a=new i(r);return t.__observeLifetime(a),a},t._OnReady=function(){t._BindingsReady=!0,t._WindowLoaded&&t.trigger("Ready")},t._OnWindowLoaded=function(){t._WindowLoaded=!0,t._BindingsReady&&t.trigger("Ready")},t._ThrowError=function(e){var t=e.name+": "+e.message+"\n"+e.stack.split("\n").map(function(e){return"\t"+e}).join("\n");console.error(t)},n?e.onload=function(e){return function(){e&&e(),t._OnWindowLoaded()}}(e.onload):t._WindowLoaded=!0,t._coherentGlobalCanvas=document.createElement("canvas"),t._coherentGlobalCanvas.id="coherentGlobalCanvas",t._coherentGlobalCanvas.width=1,t._coherentGlobalCanvas.height=1,t._coherentGlobalCanvas.style.zIndex=0,t._coherentGlobalCanvas.style.position="absolute",t._coherentGlobalCanvas.style.border="0px solid",t._coherentLiveImageData=[],t._coherentCreateImageData=function(e,n){var r=t._coherentGlobalCanvas.getContext("2d").coherentCreateImageData(n);t._coherentLiveImageData[e]=r},t._coherentUpdatedImageData=function(e){t._coherentLiveImageData[e].coherentUpdate();for(var n=document.getElementsByTagName("canvas"),r=0;r<n.length;++r)null!==n[r].onEngineImageDataUpdated&&n[r].onEngineImageDataUpdated(e,t._coherentLiveImageData[e])},t.reloadLocalization=function(){for(var e=document.querySelectorAll("[data-l10n-id]"),n=0;n<e.length;n++){var r=e.item(n),o=t.translate(r.dataset.l10nId);if(o)r.textContent=o;else{var i="Failed to find translation for key: "+r.dataset.l10nId;console.warn(i)}}},t.on("_coherentCreateImageData",t._coherentCreateImageData),t.on("_coherentUpdatedImageData",t._coherentUpdatedImageData),t.on("_Result",t._Result,t),t.on("_Register",t._Register,t),t.on("_Unregister",t._Unregister,t),t.on("_OnReady",t._OnReady,t),t.on("_OnError",t._OnError,t),t.on("__OnReplayRecordCompleted",function(e){t.onEventsReplayed&&t.onEventsReplayed()}),t.BindingsReady(l[0],l[1],l[2],l[3]),t});