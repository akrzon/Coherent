"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var when=require("when"),enums_1=require("./enums"),main_1=require("../scripts/main"),function_helpers_1=require("./function_helpers"),enums_2=require("./enums"),globals_1=require("../scripts/globals/globals"),editor_settings_1=require("./editor_settings"),runtimeCore;!function(e){function t(e){for(var t="",n=0;n<e.length;n++)t+="'"+e[n]+"',";return t.substring(0,t.length-1)}function n(e){var t=document.createElement("div");return t.innerHTML=e.trim(),i(t,0).innerHTML}function i(e,t){for(var n,r=new Array(1+t++).join("  "),o=new Array(t-1).join("  "),a=0;a<e.children.length;a++)n=document.createTextNode("\n"+r),e.insertBefore(n,e.children[a]),i(e.children[a],t),e.lastElementChild===e.children[a]&&(n=document.createTextNode("\n"+o),e.appendChild(n));return e}function r(e,t,n,i){var r=main_1.default.openFiles[main_1.default.selectedEditor].runtimeEditor;if(r&&r._sceneActionState.pasteWidget&&main_1.default.copiedWidgets.widgets[e.id]&&main_1.default.copiedWidgets.widgets[e.id].nestedElementId){var o=e.id,a=main_1.default.generateRandomId(e.type);e.id=a,t.id=a,r.cloneAnimations(a,o)}else void 0!==e.id&&(t.id=e.id);if(void 0!==e.className)if(""!==t.className)for(var s=e.className.split(" "),d=s.length,l=0;l<d;l++)t.classList.add(s[l]);else t.className=e.className;if(void 0!==e.background&&(t.style.background=e.background,t.style.backgroundRepeat="repeat"),e.styles.mixBlendMode&&"normal"===e.styles.mixBlendMode&&(t.style.mixBlendMode=e.styles.mixBlendMode),e.styles.backgroundBlendMode&&"normal"===e.styles.backgroundBlendMode&&(t.style.backgroundBlendMode=e.styles.backgroundBlendMode),e.selected&&t.setAttribute("selected","selected"),e.multiple&&t.setAttribute("multiple","multiple"),e.checked&&t.setAttribute("checked","checked"),void 0!==e.attrs&&y(t,e.attrs),void 0!==e.dataBindings){var c=e.dataBindings;for(var u in c)""!==c[u]&&t.setAttribute(enums_1.default.DataBindingGroups[u],c[u])}if(void 0!==e.styles&&b(t,e.styles,e.type),void 0!==e["-webkit-filter"]&&w(t,e["-webkit-filter"],"webkitFilter"),void 0!==e.geometry&&b(t,e.geometry,e.type),"Hummingbird"!==main_1.default.preferences.couiEnvironment||void 0!==t.style.maskImage&&""!==t.style.maskImage||void 0===i||(t.style.mask="",t.style.maskSize="",t.style.maskRepeat="",t.style.maskPosition="",t.style.maskImage=""),void 0!==e.transform&&void 0!==e.transform.rotate?t.style.transform="rotate("+e.transform.rotate+")":void 0!==e.transform&&(t.style.transform=function_helpers_1.default.buildTransformStyles(e)),e["transform-origin"]){var m=e["transform-origin"]["transform-origin-x"]||"50%",f=e["transform-origin"]["transform-origin-y"]||"50%";t.style.transformOrigin=m+"  "+f}if(e["perspective-origin"]){var p=e["perspective-origin"]["perspective-origin-x"]||"50%",g=e["perspective-origin"]["perspective-origin-y"]||"50%";t.style.perspectiveOrigin=p+"  "+g}if(void 0!==e.boxShadow){var v=e.boxShadow;"none"===v.insetOutset?v.insetOutset="":v.insetOutset=v.insetOutset+" ",t.style.boxShadow=v.insetOutset+v.horizontalLength+" "+v.verticalLength+" "+v.blurRadius+" "+v.spreadRadius+" "+v.color}if(void 0!==e.text&&(t.textContent=e.text),void 0!==e["-coherent-layer-clip-aa"]&&(t.style["-coherent-layer-clip-aa"]=e["-coherent-layer-clip-aa"]),void 0!==e.color&&(t.style.color=e.color),void 0!==e.fontSize&&""!==e.fontSize&&(t.style.fontSize=e.fontSize),void 0!==e.fontFamily&&(t.style.fontFamily=e.fontFamily),"liveview"===e.type&&t.setAttribute("src","liveview://"+e.attrs.src.trim()),void 0!==e.children&&e.children.length>0&&A(t,e.children,i),e.type&&(e.widgetkit?t.setAttribute("data-type","widget"):t.setAttribute("data-type",e.type)),e.widgetkit&&t.setAttribute("data-widgetkit",e.widgetkit),e.events&&i&&i.options)for(var h in e.events)if(e.events.hasOwnProperty(h)){var _=e.events[h];for(var k in _)_.hasOwnProperty(k)&&("javascriptFunction"===k?t.setAttribute("data-"+h,_[k]):t.setAttribute("data-"+h,k+"("+_[k]+")"))}t.setAttribute("data-element-type","widget"),t.setAttribute("data-element-selectable","true"),$(t).on("mousedown",function(e){r.inputSearch.focusout(),e.preventDefault()}),e.selectable=!0,n.appendChild(t),void 0!==i?i.options||i.runtimeEditor.recalculateUnits(t,e.id):void 0!==e.events&&E(t,e.events)}function o(e,t,n,i){for(var r=document.createDocumentFragment(),o=e.widgets,a=o.length,s=0;s<a;++s)h(o[s],r,i);if(t.appendChild(r),O(t),void 0!==i){var d=$("#scene video");i.runtimeEditor.displayVideos(d),void 0!==i.endAllCallback&&i.endAllCallback()}return when()}var a={},s=enums_2.default.nonDisplayInheritElements,d=function(){return void 0!==window.globalEditorInfo};window.engine=window.engine||void 0;var l=function(){return window.engine&&void 0!==window.engine.on};document.createElement("style").id="style-runtime",d()&&(vex.defaultOptions.className="vex-theme-flat-attack");var c=function(e){if(void 0===e)return when();for(var t=e.length,n=[],i=0;i<t;++i)n.push(System.import("runtime_editor/"+e[i]).catch(function(e){console.error.bind(console),d()&&vex.dialog.alert(e)}));return when.all(n)},u=function(e,t,n){return c(e.deps).then(function(i){var r=e.styles.length;if(0!==r)for(var a=0;a<r;a++){var s=document.createElement("link");s.rel="stylesheet",s.property="stylesheet",s.type="text/css",s.className="styles",s.href=e.styles[a],t.appendChild(s)}return o(e,t,0,n)}).then(function(){var n,i=e.scripts.length;if(0!==i)for(var r=0;r<i;r++)(n=document.createElement("script")).className="scripts",n.src=e.scripts[r],t.appendChild(n)}).then(function(){return p(e.widgets,t,e,n)}).then(function(){return m(e.animationClasses,t,n)}).then(function(i){return $(t).find("*").css("cursor",""),g(t,i,e,n)})},m=function(e,t,n){for(var i=Object.keys(e),r=0;r<i.length;r++)$.isEmptyObject(e[i[r]].keyframes)&&delete e[i[r]];return n.runtimeEditor.Animations.exportToCss(e)},f=function(e,n){var i,r;if(e.children.length)for(var o in e.children)e.children.hasOwnProperty(o)&&(n=f(e.children[o],n));if(e.events){i=e.events,r='document.getElementById("'+e.id+'")';for(var a in i){var s=i[a];for(var d in s)switch(d){case"javascriptFunction":n+=r+'.addEventListener("'+a+'", function() { '+s[d]+" });\n";break;case"engineCallArguments":n+=r+'.addEventListener("'+a+'", function() { engine.call.apply(engine, ['+t(s[d])+"]); });\n";break;case"engineTriggerArguments":n+=r+'.addEventListener("'+a+'", function() { engine.trigger.apply(engine, ['+t(s[d])+"]); });\n";break;case"blueprintFunction":n+=r+'.addEventListener("'+a+"\", function() { engine.trigger('"+s[d]+"'); });\n"}}}return n},p=function(e,t,n,i){var r=document.createElement("script"),o=document.createElement("script"),a=n.sceneEvents.sceneLoad,s="";r.className="local-events",o.className="global-events",o.textContent=a;for(var d in e)s=f(e[d],s);r.textContent="(function(){\n"+s+"\n})();\n",t.appendChild(o),t.appendChild(r)},g=function(e,t,i,r){var o="",a="",s="",d="",l=main_1.default.openFiles[main_1.default.selectedEditor],c=main_1.default.preferences.couiEnvironment,u=main_1.default.environmentProperties;if(0!==i.fonts.length&&i.fonts.map(function(e){s+=function_helpers_1.default.buildFontCss(e)}),r.options&&r.options.publishScene){var m=function_helpers_1.default.buildPublishPage(e,c);d="\n"+u.ORIGINAL_SOURCE_SCENE_PATH+"\n\n\x3c!-- "+r.options.originalSceneName+" --\x3e\n\n"+u.ORIGINAL_SOURCE_SCENE_PATH_END,o=s+"\n"+m.css,a=m.cleanedHTML,s=""}else s='<style id="coui_font_faces">\n'+s+"</style>",a=e.innerHTML;var f="scene";if(l.runtimeEditor){var p=l.tab.tabWidgetState.editWidget,g=l.tab.tabWidgetState.createNewWidget;(p||g)&&i.widgets[0]&&i.widgets[0].widgetkit&&!i.widgets[0].widgetkit.endsWith(".component")&&(f=i.widgets[0].widgetkit),l.tab.tabWidgetState.createNewWidget=!1}var v='\'{"width": "'+i.sceneSize.width+'", "height": "'+i.sceneSize.height+'", "type": "'+i.sceneSize.type+"\"}'",h={style:i.style,sceneType:f};a=n(a);var y="body {background-color:"+i.style.backgroundColor+";}",b="";editor_settings_1.default.environment.GT===main_1.default.preferences.couiEnvironment?b=' * {\n\tmargin: 0;\n\tpadding: 0;\n\tbox-sizing: border-box;\n\tfont-family:"Helvetica Neue",Helvetica, Arial,sans-serif;\n}\n':editor_settings_1.default.environment.Hummingbird===main_1.default.preferences.couiEnvironment&&(b=' * {\n\tbox-sizing: border-box;\n\tfont-family:"Helvetica Neue",Helvetica, Arial,sans-serif;\n}\n');var _="";if(editor_settings_1.default.environment.Hummingbird===main_1.default.preferences.couiEnvironment){_="body {\n\twidth: 100vw;\n\theight: 100vh;\n}\n";a=(a=a.split(/(?:flex-flow:|-webkit-flex-flow:)(.*?)(?:;)/gm).map(function(e){if(-1===e.indexOf(">")&&-1===e.indexOf("<")){var t=e.trim().split(" ");return"flex-direction: "+t[0]+";"+" "+("flex-wrap: "+t[1]+";")}return-1!==e.indexOf("-webkit-")?e.replace(/-webkit-/gm,""):e}).join("")).replace(/.mask:.*?;/gm,function(e){var t=" mask-image: ";return t+=e.match(/url\(.*?\)/)[0]+"; mask-position: ",t+=e.match(/\).*?\//)[0].replace(") ","").replace(" /","")+"; mask-repeat: ",t+=e.match(/(repeat|no-repeat).*?;/)[0]})}else editor_settings_1.default.environment.GT===main_1.default.preferences.couiEnvironment&&(a=a.replace(/-webkit-mask:.*?;/gm,function(e){return e.replace("/ inherit ","")}));var w="<script>\n"+u.EDITOR_VERSION_MARK_START+'\nvar version = "'+main_1.default.EDITOR_VERSION.join(".")+'"; \n'+u.EDITOR_VERSION_MARK_END+"\n"+u.EDITOR_ENV_MARK_START+'\nvar environment = "'+main_1.default.preferences.couiEnvironment+'"; \n'+u.EDITOR_ENV_MARK_END+"\n"+u.ASPECT_RATIO_MARK_START+"\nvar sceneAspectRatio = "+v+"\n"+u.ASPECT_RATIO_MARK_END+"\n"+globals_1.default.marker.scenePropertiesStart+"\n var sceneProperties = "+JSON.stringify(h)+"\n"+globals_1.default.marker.scenePropertiesEnd+"\n<\/script>\n";return d+"\n"+u.COMMENT_MARK_START+"\n"+t+"\n"+(r.options&&r.options.publishScene?"":w)+s+"<style>\n"+b+_+y+"\n"+o+"</style>\n</head>\n<body>\n"+a+"\n"+u.COMMENT_MARK_END+"\n"},v=function(e,t){return when(System.import("runtime_editor/"+e+"!text")).then(function(e){return e=JSON.parse(e),u(e,t)})},h=function(e,t,n){var i=a[e.type];return void 0===i&&(i=a[e.type]=function(){var n=document.createTextNode(JSON.stringify(e));t.appendChild(n)}),i(e,t,n)},y=function(e,t){for(var n in t)""!==t[n]&&e.setAttribute(n,t[n])},b=function(e,t,n){for(var i in t)if(_(i,t[i],n))if("backgroundSize"===i&&"auto"===t[i]){var r=t.backgroundSizeWidth||"auto",o=t.backgroundSizeHeight||"auto";e.style[i]=r+" "+o}else if("-webkit-mask-size"===i&&"auto"===t[i]){var a=t["-webkit-mask-sizeWidth"]||"auto",s=t["-webkit-mask-sizeHeight"]||"auto";e.style[i]=a+" "+s}else e.style[i]=t[i]},_=function(e,t,n){return(-1===["textTransform","textDecoration","backgroundSizeWidth, backgroundSizeHeight","-webkit-mask-sizeWidth","-webkit-mask-sizeHeight"].indexOf(e)||"none"!==t)&&!("display"===e&&"inherit"===t&&!s.includes(n))},w=function(e,t,n){var i="";for(var r in t){var o=t[r];"rotate"===r&&(o=function_helpers_1.default.toDegrees(parseFloat(o))+"deg"),"dropShadowColor"!==r&&"dropShadowX"!==r&&"dropShadowY"!==r&&"dropShadowBlur"!==r&&(i+=r+"("+o+") ")}i+=function_helpers_1.default.buildDropShadowProperty(t),e.style[n]=i},E=function(e,t){l()?k(e,t):(System.config({paths:{coherent:"lib/coherent.js"}}),System.import("runtime_editor/coherent").then(function(n){window.engine=n,k(e,t)}))},k=function(e,t){var n;for(n in t)!function(t){"object"==typeof t?t.engineCallArguments?e.addEventListener(n,function(){engine.call.apply(engine,t.engineCallArguments)},!1):t.engineTriggerArguments?e.addEventListener(n,function(){engine.trigger.apply(engine,t.engineTriggerArguments)},!1):t.blueprintFunction?e.addEventListener(n,function(){engine.trigger(t.blueprintFunction)},!1):t.javascriptFunction&&e.addEventListener(n,new Function(t.javascriptFunction),!1):e.addEventListener(n,window.editorEvents[t],!1)}(t[n])},A=function(e,t,n){for(var i=t.length,r=0;r<i;++r)h(t[r],e,n)},S=function(e,t,n){r(e,"ellipse"===e.type||"rectangle"===e.type||"roundedRect"===e.type||"circle"===e.type||"responsiveImage"===e.type||"widget"===e.type?document.createElement("div"):document.createElement(e.type),t,n)},x=function(e,t,n){var i=document.createElement("input");"inputText"===e.type?i.setAttribute("type","text"):i.setAttribute("type",e.type),"range"===e.type&&$(i).val(0).trigger("change"),r(e,i,t,n)},C=function(e,t,n){var i=new Image;i.src=e.url,void 0!==e.width&&(i.width=e.width),void 0!==e.height&&(i.height=e.height),r(e,i,t,n)};a={widget:S,div:S,responsiveImage:S,image:C,liveview:C,video:function(e,t,n){var i=document.createElement("video");i.src=e.url,r(e,i,t,n)},text:function(e,t,n){var i=document.createElement("div");i.textContent=e.text,r(e,i,t,n)},label:S,button:S,inputText:x,select:S,range:x,number:x,option:S,checkbox:x,radio:x,textarea:S,ul:S,ol:S,li:S,rectangle:S,ellipse:S,circle:S,roundedRect:S};var N=function(e,t){for(var n=0;n<e.length;n++)e[n].attributes&&(e[n].hasAttribute("data-element-selectable")&&e[n].removeAttribute("data-element-selectable"),e[n].setAttribute("data-parent-widget-id",t.id)),e[n].childNodes.length>0&&N(e[n].childNodes,t)},O=function(e){var t=e.querySelectorAll('[data-type="widget"]'),n=t.length;if(n>0)for(var i=0;i<n;i++){var r=t[i].childNodes,o=main_1.default.openFiles[main_1.default.selectedEditor].tab.tabWidgetState;o.importedWidget&&!o.editWidget&&N(r,t[i])}};e.setupProperties=r,e.createComponent=function(e,t){var n=document.createDocumentFragment();h(e,n,t);var i=$("<div></div>");return i[0].appendChild(n),i.html()},e.loadAndCreateObj=function(e,t,n){return u(e,t,n)},e.loadAndCreate=function(e,t){return v(e,t)},e.create=o,e.createAnElement=function(e,t,n){var i=document.createDocumentFragment();h(e,i,n),t.appendChild(i),O(t)},e.addFactory=function(e,t){a[e]=t},e.promise=function(e){return when(e)},e.factoriesExport=a}(runtimeCore=exports.runtimeCore||(exports.runtimeCore={})),exports.default={loadSceneObj:runtimeCore.loadAndCreateObj,load:runtimeCore.loadAndCreate,create:runtimeCore.create,createAnElement:runtimeCore.createAnElement,addFactory:runtimeCore.addFactory,promise:runtimeCore.promise,setupProperties:runtimeCore.setupProperties,createComponent:runtimeCore.createComponent,factories:runtimeCore.factoriesExport};